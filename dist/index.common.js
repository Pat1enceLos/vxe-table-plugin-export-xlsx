"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExport = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var XLSX = _interopRequireWildcard(require("xlsx"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      original = options.original,
      message = options.message;
  var colHead = {};

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = original ? column.property : column.getTitle();
    });
  }

  var rowList = datas.map(function (row) {
    var item = {};
    columns.forEach(function (column) {
      item[column.id] = original ? _xeUtils["default"].get(row, column.property) : row[column.id];
    });
    return item;
  });
  var book = XLSX.utils.book_new();
  var sheet = XLSX.utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList), {
    skipHeader: true
  }); // 转换数据

  XLSX.utils.book_append_sheet(book, sheet, sheetName);
  var wbout = XLSX.write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });
  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  download(blob, options);

  if (message) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function download(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, filename);
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error('[vxe-table-plugin-export] The current environment does not support exports.');
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').forEach(function (val) {
      var field = replaceDoubleQuotation(val);

      if (field) {
        fields.push(field);
      }
    });
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          item[fields[colIndex]] = replaceDoubleQuotation(val);
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var $table = params.$table,
      columns = params.columns,
      options = params.options,
      file = params.file;
  var _importCallback = $table._importCallback;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = XLSX.read(e.target.result, {
      type: 'binary'
    });
    var csvData = XLSX.utils.sheet_to_csv(workbook.Sheets.Sheet1);
    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message) {
        $table.$XModal.message({
          message: i18n('vxe.table.impSuccess'),
          status: 'success'
        });
      }
    } else if (options.message) {
      $table.$XModal.message({
        message: i18n('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importCallback) {
      _importCallback(status);
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  switch (params.options.type) {
    case 'xlsx':
      importXLSX(params);
      return false;
  }
}

function handleExportEvent(params) {
  switch (params.options.type) {
    case 'xlsx':
      exportXLSX(params);
      return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 等格式
 */


var VXETablePluginExport = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
    VXETablePluginExport.t = xtable.t;
  }
};
exports.VXETablePluginExport = VXETablePluginExport;

function i18n(key) {
  if (VXETablePluginExport.t) {
    return VXETablePluginExport.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExport);
}

var _default = VXETablePluginExport;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRvQnVmZmVyIiwid2JvdXQiLCJidWYiLCJBcnJheUJ1ZmZlciIsImxlbmd0aCIsInZpZXciLCJVaW50OEFycmF5IiwiaW5kZXgiLCJjaGFyQ29kZUF0IiwiZXhwb3J0WExTWCIsInBhcmFtcyIsIiR0YWJsZSIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaGVldE5hbWUiLCJ0eXBlIiwiaXNIZWFkZXIiLCJvcmlnaW5hbCIsIm1lc3NhZ2UiLCJjb2xIZWFkIiwiZm9yRWFjaCIsImNvbHVtbiIsImlkIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJvd0xpc3QiLCJtYXAiLCJyb3ciLCJpdGVtIiwiWEVVdGlscyIsImdldCIsImJvb2siLCJYTFNYIiwidXRpbHMiLCJib29rX25ldyIsInNoZWV0IiwianNvbl90b19zaGVldCIsImNvbmNhdCIsInNraXBIZWFkZXIiLCJib29rX2FwcGVuZF9zaGVldCIsIndyaXRlIiwiYm9va1R5cGUiLCJib29rU1NUIiwiYmxvYiIsIkJsb2IiLCJkb3dubG9hZCIsIiRYTW9kYWwiLCJpMThuIiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsImNvbnNvbGUiLCJlcnJvciIsInJlcGxhY2VEb3VibGVRdW90YXRpb24iLCJ2YWwiLCJyZXBsYWNlIiwicGFyc2VDc3YiLCJjb250ZW50IiwibGlzdCIsInNwbGl0IiwiZmllbGRzIiwicm93cyIsInJMaXN0Iiwic2xpY2UiLCJmaWVsZCIsInB1c2giLCJyIiwiY29sSW5kZXgiLCJjaGVja0ltcG9ydERhdGEiLCJ0YWJsZUZpZWxkcyIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRDYWxsYmFjayIsImZpbGVSZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiZSIsIndvcmtib29rIiwicmVhZCIsInJlc3VsdCIsImNzdkRhdGEiLCJzaGVldF90b19jc3YiLCJTaGVldHMiLCJTaGVldDEiLCJyZXN0IiwiY3JlYXRlRGF0YSIsInRoZW4iLCJkYXRhIiwibW9kZSIsImluc2VydEF0IiwicmVsb2FkRGF0YSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydCIsImluc3RhbGwiLCJ4dGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJpbnRlcmNlcHRvciIsIm1peGluIiwidCIsImtleSIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7Ozs7O0FBRUEsU0FBU0EsUUFBVCxDQUFrQkMsS0FBbEIsRUFBNEI7QUFDMUIsTUFBSUMsR0FBRyxHQUFHLElBQUlDLFdBQUosQ0FBZ0JGLEtBQUssQ0FBQ0csTUFBdEIsQ0FBVjtBQUNBLE1BQUlDLElBQUksR0FBRyxJQUFJQyxVQUFKLENBQWVKLEdBQWYsQ0FBWDs7QUFDQSxPQUFLLElBQUlLLEtBQUssR0FBRyxDQUFqQixFQUFvQkEsS0FBSyxLQUFLTixLQUFLLENBQUNHLE1BQXBDLEVBQTRDLEVBQUVHLEtBQTlDO0FBQXFERixJQUFBQSxJQUFJLENBQUNFLEtBQUQsQ0FBSixHQUFjTixLQUFLLENBQUNPLFVBQU4sQ0FBaUJELEtBQWpCLElBQTBCLElBQXhDO0FBQXJEOztBQUNBLFNBQU9MLEdBQVA7QUFDRDs7QUFFRCxTQUFTTyxVQUFULENBQW9CQyxNQUFwQixFQUErQjtBQUFBLE1BQ3JCQyxNQURxQixHQUNlRCxNQURmLENBQ3JCQyxNQURxQjtBQUFBLE1BQ2JDLE9BRGEsR0FDZUYsTUFEZixDQUNiRSxPQURhO0FBQUEsTUFDSkMsT0FESSxHQUNlSCxNQURmLENBQ0pHLE9BREk7QUFBQSxNQUNLQyxLQURMLEdBQ2VKLE1BRGYsQ0FDS0ksS0FETDtBQUFBLE1BRXJCQyxTQUZxQixHQUU0QkgsT0FGNUIsQ0FFckJHLFNBRnFCO0FBQUEsTUFFVkMsSUFGVSxHQUU0QkosT0FGNUIsQ0FFVkksSUFGVTtBQUFBLE1BRUpDLFFBRkksR0FFNEJMLE9BRjVCLENBRUpLLFFBRkk7QUFBQSxNQUVNQyxRQUZOLEdBRTRCTixPQUY1QixDQUVNTSxRQUZOO0FBQUEsTUFFZ0JDLE9BRmhCLEdBRTRCUCxPQUY1QixDQUVnQk8sT0FGaEI7QUFHN0IsTUFBTUMsT0FBTyxHQUFRLEVBQXJCOztBQUNBLE1BQUlILFFBQUosRUFBYztBQUNaSixJQUFBQSxPQUFPLENBQUNRLE9BQVIsQ0FBZ0IsVUFBQ0MsTUFBRCxFQUFnQjtBQUM5QkYsTUFBQUEsT0FBTyxDQUFDRSxNQUFNLENBQUNDLEVBQVIsQ0FBUCxHQUFxQkwsUUFBUSxHQUFHSSxNQUFNLENBQUNFLFFBQVYsR0FBcUJGLE1BQU0sQ0FBQ0csUUFBUCxFQUFsRDtBQUNELEtBRkQ7QUFHRDs7QUFDRCxNQUFNQyxPQUFPLEdBQUdaLEtBQUssQ0FBQ2EsR0FBTixDQUFVLFVBQUNDLEdBQUQsRUFBYTtBQUNyQyxRQUFNQyxJQUFJLEdBQVEsRUFBbEI7QUFDQWhCLElBQUFBLE9BQU8sQ0FBQ1EsT0FBUixDQUFnQixVQUFDQyxNQUFELEVBQWdCO0FBQzlCTyxNQUFBQSxJQUFJLENBQUNQLE1BQU0sQ0FBQ0MsRUFBUixDQUFKLEdBQWtCTCxRQUFRLEdBQUdZLG9CQUFRQyxHQUFSLENBQVlILEdBQVosRUFBaUJOLE1BQU0sQ0FBQ0UsUUFBeEIsQ0FBSCxHQUF1Q0ksR0FBRyxDQUFDTixNQUFNLENBQUNDLEVBQVIsQ0FBcEU7QUFDRCxLQUZEO0FBR0EsV0FBT00sSUFBUDtBQUNELEdBTmUsQ0FBaEI7QUFPQSxNQUFNRyxJQUFJLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxRQUFYLEVBQWI7QUFDQSxNQUFNQyxLQUFLLEdBQUdILElBQUksQ0FBQ0MsS0FBTCxDQUFXRyxhQUFYLENBQXlCLENBQUNwQixRQUFRLEdBQUcsQ0FBQ0csT0FBRCxDQUFILEdBQWUsRUFBeEIsRUFBNEJrQixNQUE1QixDQUFtQ1osT0FBbkMsQ0FBekIsRUFBc0U7QUFBRWEsSUFBQUEsVUFBVSxFQUFFO0FBQWQsR0FBdEUsQ0FBZCxDQWpCNkIsQ0FrQjdCOztBQUNBTixFQUFBQSxJQUFJLENBQUNDLEtBQUwsQ0FBV00saUJBQVgsQ0FBNkJSLElBQTdCLEVBQW1DSSxLQUFuQyxFQUEwQ3JCLFNBQTFDO0FBQ0EsTUFBTWQsS0FBSyxHQUFHZ0MsSUFBSSxDQUFDUSxLQUFMLENBQVdULElBQVgsRUFBaUI7QUFBRVUsSUFBQUEsUUFBUSxFQUFFMUIsSUFBWjtBQUFrQjJCLElBQUFBLE9BQU8sRUFBRSxLQUEzQjtBQUFrQzNCLElBQUFBLElBQUksRUFBRTtBQUF4QyxHQUFqQixDQUFkO0FBQ0EsTUFBTTRCLElBQUksR0FBRyxJQUFJQyxJQUFKLENBQVMsQ0FBQzdDLFFBQVEsQ0FBQ0MsS0FBRCxDQUFULENBQVQsRUFBNEI7QUFBRWUsSUFBQUEsSUFBSSxFQUFFO0FBQVIsR0FBNUIsQ0FBYixDQXJCNkIsQ0FzQjdCOztBQUNBOEIsRUFBQUEsUUFBUSxDQUFDRixJQUFELEVBQU9oQyxPQUFQLENBQVI7O0FBQ0EsTUFBSU8sT0FBSixFQUFhO0FBQ1hSLElBQUFBLE1BQU0sQ0FBQ29DLE9BQVAsQ0FBZTVCLE9BQWYsQ0FBdUI7QUFBRUEsTUFBQUEsT0FBTyxFQUFFNkIsSUFBSSxDQUFDLHNCQUFELENBQWY7QUFBeUNDLE1BQUFBLE1BQU0sRUFBRTtBQUFqRCxLQUF2QjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU0gsUUFBVCxDQUFrQkYsSUFBbEIsRUFBOEJoQyxPQUE5QixFQUEwQztBQUN4QyxNQUFJc0MsTUFBTSxDQUFDTCxJQUFYLEVBQWlCO0FBQUEsUUFDUE0sUUFETyxHQUNZdkMsT0FEWixDQUNQdUMsUUFETztBQUFBLFFBQ0duQyxJQURILEdBQ1lKLE9BRFosQ0FDR0ksSUFESDs7QUFFZixRQUFJb0MsU0FBUyxDQUFDQyxVQUFkLEVBQTBCO0FBQ3hCRCxNQUFBQSxTQUFTLENBQUNDLFVBQVYsQ0FBcUJULElBQXJCLEVBQTJCTyxRQUEzQjtBQUNELEtBRkQsTUFFTztBQUNMLFVBQUlHLFFBQVEsR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLEdBQXZCLENBQWY7QUFDQUYsTUFBQUEsUUFBUSxDQUFDRyxNQUFULEdBQWtCLFFBQWxCO0FBQ0FILE1BQUFBLFFBQVEsQ0FBQ1IsUUFBVCxhQUF1QkssUUFBdkIsY0FBbUNuQyxJQUFuQztBQUNBc0MsTUFBQUEsUUFBUSxDQUFDSSxJQUFULEdBQWdCQyxHQUFHLENBQUNDLGVBQUosQ0FBb0JoQixJQUFwQixDQUFoQjtBQUNBVyxNQUFBQSxRQUFRLENBQUNNLElBQVQsQ0FBY0MsV0FBZCxDQUEwQlIsUUFBMUI7QUFDQUEsTUFBQUEsUUFBUSxDQUFDUyxLQUFUO0FBQ0FSLE1BQUFBLFFBQVEsQ0FBQ00sSUFBVCxDQUFjRyxXQUFkLENBQTBCVixRQUExQjtBQUNEO0FBQ0YsR0FiRCxNQWFPO0FBQ0xXLElBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjLDZFQUFkO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTQyxzQkFBVCxDQUFnQ0MsR0FBaEMsRUFBMkM7QUFDekMsU0FBT0EsR0FBRyxDQUFDQyxPQUFKLENBQVksSUFBWixFQUFrQixFQUFsQixFQUFzQkEsT0FBdEIsQ0FBOEIsSUFBOUIsRUFBb0MsRUFBcEMsQ0FBUDtBQUNEOztBQUVELFNBQVNDLFFBQVQsQ0FBa0J6RCxPQUFsQixFQUFrQzBELE9BQWxDLEVBQWlEO0FBQy9DLE1BQU1DLElBQUksR0FBYUQsT0FBTyxDQUFDRSxLQUFSLENBQWMsSUFBZCxDQUF2QjtBQUNBLE1BQU1DLE1BQU0sR0FBVSxFQUF0QjtBQUNBLE1BQU1DLElBQUksR0FBVSxFQUFwQjs7QUFDQSxNQUFJSCxJQUFJLENBQUNwRSxNQUFULEVBQWlCO0FBQ2YsUUFBTXdFLEtBQUssR0FBYUosSUFBSSxDQUFDSyxLQUFMLENBQVcsQ0FBWCxDQUF4QjtBQUNBTCxJQUFBQSxJQUFJLENBQUMsQ0FBRCxDQUFKLENBQVFDLEtBQVIsQ0FBYyxHQUFkLEVBQW1CcEQsT0FBbkIsQ0FBMkIsVUFBQytDLEdBQUQsRUFBZ0I7QUFDekMsVUFBTVUsS0FBSyxHQUFXWCxzQkFBc0IsQ0FBQ0MsR0FBRCxDQUE1Qzs7QUFDQSxVQUFJVSxLQUFKLEVBQVc7QUFDVEosUUFBQUEsTUFBTSxDQUFDSyxJQUFQLENBQVlELEtBQVo7QUFDRDtBQUNGLEtBTEQ7QUFNQUYsSUFBQUEsS0FBSyxDQUFDdkQsT0FBTixDQUFjLFVBQUMyRCxDQUFELEVBQWM7QUFDMUIsVUFBSUEsQ0FBSixFQUFPO0FBQ0wsWUFBTW5ELElBQUksR0FBUSxFQUFsQjtBQUNBbUQsUUFBQUEsQ0FBQyxDQUFDUCxLQUFGLENBQVEsR0FBUixFQUFhcEQsT0FBYixDQUFxQixVQUFDK0MsR0FBRCxFQUFjYSxRQUFkLEVBQWtDO0FBQ3JEcEQsVUFBQUEsSUFBSSxDQUFDNkMsTUFBTSxDQUFDTyxRQUFELENBQVAsQ0FBSixHQUF5QmQsc0JBQXNCLENBQUNDLEdBQUQsQ0FBL0M7QUFDRCxTQUZEO0FBR0FPLFFBQUFBLElBQUksQ0FBQ0ksSUFBTCxDQUFVbEQsSUFBVjtBQUNEO0FBQ0YsS0FSRDtBQVNEOztBQUNELFNBQU87QUFBRTZDLElBQUFBLE1BQU0sRUFBTkEsTUFBRjtBQUFVQyxJQUFBQSxJQUFJLEVBQUpBO0FBQVYsR0FBUDtBQUNEOztBQUVELFNBQVNPLGVBQVQsQ0FBeUJyRSxPQUF6QixFQUF5QzZELE1BQXpDLEVBQTJEQyxJQUEzRCxFQUFzRTtBQUNwRSxNQUFJUSxXQUFXLEdBQWEsRUFBNUI7QUFDQXRFLEVBQUFBLE9BQU8sQ0FBQ1EsT0FBUixDQUFnQixVQUFDQyxNQUFELEVBQWdCO0FBQzlCLFFBQUl3RCxLQUFLLEdBQVd4RCxNQUFNLENBQUNFLFFBQTNCOztBQUNBLFFBQUlzRCxLQUFKLEVBQVc7QUFDVEssTUFBQUEsV0FBVyxDQUFDSixJQUFaLENBQWlCRCxLQUFqQjtBQUNEO0FBQ0YsR0FMRDtBQU1BLFNBQU9LLFdBQVcsQ0FBQ0MsS0FBWixDQUFrQixVQUFDTixLQUFEO0FBQUEsV0FBbUJKLE1BQU0sQ0FBQ1csUUFBUCxDQUFnQlAsS0FBaEIsQ0FBbkI7QUFBQSxHQUFsQixDQUFQO0FBQ0Q7O0FBRUQsU0FBU1EsVUFBVCxDQUFvQjVFLE1BQXBCLEVBQStCO0FBQUEsTUFDckJDLE1BRHFCLEdBQ2NELE1BRGQsQ0FDckJDLE1BRHFCO0FBQUEsTUFDYkUsT0FEYSxHQUNjSCxNQURkLENBQ2JHLE9BRGE7QUFBQSxNQUNKRCxPQURJLEdBQ2NGLE1BRGQsQ0FDSkUsT0FESTtBQUFBLE1BQ0syRSxJQURMLEdBQ2M3RSxNQURkLENBQ0s2RSxJQURMO0FBQUEsTUFFckJDLGVBRnFCLEdBRUQ3RSxNQUZDLENBRXJCNkUsZUFGcUI7QUFHN0IsTUFBTUMsVUFBVSxHQUFHLElBQUlDLFVBQUosRUFBbkI7O0FBQ0FELEVBQUFBLFVBQVUsQ0FBQ0UsTUFBWCxHQUFvQixVQUFDQyxDQUFELEVBQVc7QUFDN0IsUUFBTUMsUUFBUSxHQUFHNUQsSUFBSSxDQUFDNkQsSUFBTCxDQUFVRixDQUFDLENBQUNuQyxNQUFGLENBQVNzQyxNQUFuQixFQUEyQjtBQUFFL0UsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBM0IsQ0FBakI7QUFDQSxRQUFNZ0YsT0FBTyxHQUFXL0QsSUFBSSxDQUFDQyxLQUFMLENBQVcrRCxZQUFYLENBQXdCSixRQUFRLENBQUNLLE1BQVQsQ0FBZ0JDLE1BQXhDLENBQXhCO0FBQ0EsUUFBTUMsSUFBSSxHQUFROUIsUUFBUSxDQUFDekQsT0FBRCxFQUFVbUYsT0FBVixDQUExQjtBQUg2QixRQUlyQnRCLE1BSnFCLEdBSUowQixJQUpJLENBSXJCMUIsTUFKcUI7QUFBQSxRQUliQyxJQUphLEdBSUp5QixJQUpJLENBSWJ6QixJQUphO0FBSzdCLFFBQU0xQixNQUFNLEdBQUdpQyxlQUFlLENBQUNyRSxPQUFELEVBQVU2RCxNQUFWLEVBQWtCQyxJQUFsQixDQUE5Qjs7QUFDQSxRQUFJMUIsTUFBSixFQUFZO0FBQ1Z0QyxNQUFBQSxNQUFNLENBQUMwRixVQUFQLENBQWtCMUIsSUFBbEIsRUFDRzJCLElBREgsQ0FDUSxVQUFDQyxJQUFELEVBQWdCO0FBQ3BCLFlBQUkzRixPQUFPLENBQUM0RixJQUFSLEtBQWlCLFFBQXJCLEVBQStCO0FBQzdCN0YsVUFBQUEsTUFBTSxDQUFDOEYsUUFBUCxDQUFnQkYsSUFBaEIsRUFBc0IsQ0FBQyxDQUF2QjtBQUNELFNBRkQsTUFFTztBQUNMNUYsVUFBQUEsTUFBTSxDQUFDK0YsVUFBUCxDQUFrQkgsSUFBbEI7QUFDRDtBQUNGLE9BUEg7O0FBUUEsVUFBSTNGLE9BQU8sQ0FBQ08sT0FBWixFQUFxQjtBQUNuQlIsUUFBQUEsTUFBTSxDQUFDb0MsT0FBUCxDQUFlNUIsT0FBZixDQUF1QjtBQUFFQSxVQUFBQSxPQUFPLEVBQUU2QixJQUFJLENBQUMsc0JBQUQsQ0FBZjtBQUF5Q0MsVUFBQUEsTUFBTSxFQUFFO0FBQWpELFNBQXZCO0FBQ0Q7QUFDRixLQVpELE1BWU8sSUFBSXJDLE9BQU8sQ0FBQ08sT0FBWixFQUFxQjtBQUMxQlIsTUFBQUEsTUFBTSxDQUFDb0MsT0FBUCxDQUFlNUIsT0FBZixDQUF1QjtBQUFFQSxRQUFBQSxPQUFPLEVBQUU2QixJQUFJLENBQUMscUJBQUQsQ0FBZjtBQUF3Q0MsUUFBQUEsTUFBTSxFQUFFO0FBQWhELE9BQXZCO0FBQ0Q7O0FBQ0QsUUFBSXVDLGVBQUosRUFBcUI7QUFDbkJBLE1BQUFBLGVBQWUsQ0FBQ3ZDLE1BQUQsQ0FBZjtBQUNEO0FBQ0YsR0F4QkQ7O0FBeUJBd0MsRUFBQUEsVUFBVSxDQUFDa0Isa0JBQVgsQ0FBOEJwQixJQUE5QjtBQUNEOztBQUVELFNBQVNxQixpQkFBVCxDQUEyQmxHLE1BQTNCLEVBQXNDO0FBQ3BDLFVBQVFBLE1BQU0sQ0FBQ0UsT0FBUCxDQUFlSSxJQUF2QjtBQUNFLFNBQUssTUFBTDtBQUNFc0UsTUFBQUEsVUFBVSxDQUFDNUUsTUFBRCxDQUFWO0FBQ0EsYUFBTyxLQUFQO0FBSEo7QUFLRDs7QUFFRCxTQUFTbUcsaUJBQVQsQ0FBMkJuRyxNQUEzQixFQUFzQztBQUNwQyxVQUFRQSxNQUFNLENBQUNFLE9BQVAsQ0FBZUksSUFBdkI7QUFDRSxTQUFLLE1BQUw7QUFDRVAsTUFBQUEsVUFBVSxDQUFDQyxNQUFELENBQVY7QUFDQSxhQUFPLEtBQVA7QUFISjtBQUtEO0FBRUQ7Ozs7O0FBR08sSUFBTW9HLG9CQUFvQixHQUFRO0FBQ3ZDQyxFQUFBQSxPQUR1QyxtQkFDL0JDLE1BRCtCLEVBQ1I7QUFDN0JDLElBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixNQUFNLENBQUNHLEtBQXJCLEVBQTRCO0FBQUVDLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQTVCO0FBQ0FKLElBQUFBLE1BQU0sQ0FBQ0ssV0FBUCxDQUFtQkMsS0FBbkIsQ0FBeUI7QUFDdkIsc0JBQWdCVixpQkFETztBQUV2QixzQkFBZ0JDO0FBRk8sS0FBekI7QUFJQUMsSUFBQUEsb0JBQW9CLENBQUNTLENBQXJCLEdBQXlCUCxNQUFNLENBQUNPLENBQWhDO0FBQ0Q7QUFSc0MsQ0FBbEM7OztBQVdQLFNBQVN2RSxJQUFULENBQWN3RSxHQUFkLEVBQXlCO0FBQ3ZCLE1BQUlWLG9CQUFvQixDQUFDUyxDQUF6QixFQUE0QjtBQUMxQixXQUFPVCxvQkFBb0IsQ0FBQ1MsQ0FBckIsQ0FBdUJDLEdBQXZCLENBQVA7QUFDRDtBQUNGOztBQUVELElBQUksT0FBT3RFLE1BQVAsS0FBa0IsV0FBbEIsSUFBaUNBLE1BQU0sQ0FBQ3VFLFFBQTVDLEVBQXNEO0FBQ3BEdkUsRUFBQUEsTUFBTSxDQUFDdUUsUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JaLG9CQUFwQjtBQUNEOztlQUVjQSxvQiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQgVlhFVGFibGUgZnJvbSAndnhlLXRhYmxlL2xpYi92eGUtdGFibGUnXHJcbmltcG9ydCAqIGFzIFhMU1ggZnJvbSAneGxzeCdcclxuXHJcbmZ1bmN0aW9uIHRvQnVmZmVyKHdib3V0OiBhbnkpIHtcclxuICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKHdib3V0Lmxlbmd0aClcclxuICBsZXQgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZilcclxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4ICE9PSB3Ym91dC5sZW5ndGg7ICsraW5kZXgpIHZpZXdbaW5kZXhdID0gd2JvdXQuY2hhckNvZGVBdChpbmRleCkgJiAweEZGXHJcbiAgcmV0dXJuIGJ1ZlxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRYTFNYKHBhcmFtczogYW55KSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IHNoZWV0TmFtZSwgdHlwZSwgaXNIZWFkZXIsIG9yaWdpbmFsLCBtZXNzYWdlIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgY29sSGVhZDogYW55ID0ge31cclxuICBpZiAoaXNIZWFkZXIpIHtcclxuICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgICAgY29sSGVhZFtjb2x1bW4uaWRdID0gb3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKVxyXG4gICAgfSlcclxuICB9XHJcbiAgY29uc3Qgcm93TGlzdCA9IGRhdGFzLm1hcCgocm93OiBhbnkpID0+IHtcclxuICAgIGNvbnN0IGl0ZW06IGFueSA9IHt9XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IG9yaWdpbmFsID8gWEVVdGlscy5nZXQocm93LCBjb2x1bW4ucHJvcGVydHkpIDogcm93W2NvbHVtbi5pZF1cclxuICAgIH0pXHJcbiAgICByZXR1cm4gaXRlbVxyXG4gIH0pXHJcbiAgY29uc3QgYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKVxyXG4gIGNvbnN0IHNoZWV0ID0gWExTWC51dGlscy5qc29uX3RvX3NoZWV0KChpc0hlYWRlciA/IFtjb2xIZWFkXSA6IFtdKS5jb25jYXQocm93TGlzdCksIHsgc2tpcEhlYWRlcjogdHJ1ZSB9KVxyXG4gIC8vIOi9rOaNouaVsOaNrlxyXG4gIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQoYm9vaywgc2hlZXQsIHNoZWV0TmFtZSlcclxuICBjb25zdCB3Ym91dCA9IFhMU1gud3JpdGUoYm9vaywgeyBib29rVHlwZTogdHlwZSwgYm9va1NTVDogZmFsc2UsIHR5cGU6ICdiaW5hcnknIH0pXHJcbiAgY29uc3QgYmxvYiA9IG5ldyBCbG9iKFt0b0J1ZmZlcih3Ym91dCldLCB7IHR5cGU6ICdhcHBsaWNhdGlvbi9vY3RldC1zdHJlYW0nIH0pXHJcbiAgLy8g5L+d5a2Y5a+85Ye6XHJcbiAgZG93bmxvYWQoYmxvYiwgb3B0aW9ucylcclxuICBpZiAobWVzc2FnZSkge1xyXG4gICAgJHRhYmxlLiRYTW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IGkxOG4oJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZChibG9iOiBCbG9iLCBvcHRpb25zOiBhbnkpIHtcclxuICBpZiAod2luZG93LkJsb2IpIHtcclxuICAgIGNvbnN0IHsgZmlsZW5hbWUsIHR5cGUgfSA9IG9wdGlvbnNcclxuICAgIGlmIChuYXZpZ2F0b3IubXNTYXZlQmxvYikge1xyXG4gICAgICBuYXZpZ2F0b3IubXNTYXZlQmxvYihibG9iLCBmaWxlbmFtZSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhciBsaW5rRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKVxyXG4gICAgICBsaW5rRWxlbS50YXJnZXQgPSAnX2JsYW5rJ1xyXG4gICAgICBsaW5rRWxlbS5kb3dubG9hZCA9IGAke2ZpbGVuYW1lfS4ke3R5cGV9YFxyXG4gICAgICBsaW5rRWxlbS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmtFbGVtKVxyXG4gICAgICBsaW5rRWxlbS5jbGljaygpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGlua0VsZW0pXHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ1t2eGUtdGFibGUtcGx1Z2luLWV4cG9ydF0gVGhlIGN1cnJlbnQgZW52aXJvbm1lbnQgZG9lcyBub3Qgc3VwcG9ydCBleHBvcnRzLicpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbDogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIHZhbC5yZXBsYWNlKC9eXCIvLCAnJykucmVwbGFjZSgvXCIkLywgJycpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3N2KGNvbHVtbnM6IGFueVtdLCBjb250ZW50OiBzdHJpbmcpIHtcclxuICBjb25zdCBsaXN0OiBzdHJpbmdbXSA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpXHJcbiAgY29uc3QgZmllbGRzOiBhbnlbXSA9IFtdXHJcbiAgY29uc3Qgcm93czogYW55W10gPSBbXVxyXG4gIGlmIChsaXN0Lmxlbmd0aCkge1xyXG4gICAgY29uc3Qgckxpc3Q6IHN0cmluZ1tdID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLmZvckVhY2goKHZhbDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IGZpZWxkOiBzdHJpbmcgPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbClcclxuICAgICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgICAgZmllbGRzLnB1c2goZmllbGQpXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICByTGlzdC5mb3JFYWNoKChyOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHIpIHtcclxuICAgICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICAgIHIuc3BsaXQoJywnKS5mb3JFYWNoKCh2YWw6IHN0cmluZywgY29sSW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgaXRlbVtmaWVsZHNbY29sSW5kZXhdXSA9IHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcm93cy5wdXNoKGl0ZW0pXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG4gIHJldHVybiB7IGZpZWxkcywgcm93cyB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zOiBhbnlbXSwgZmllbGRzOiBzdHJpbmdbXSwgcm93czogYW55W10pIHtcclxuICBsZXQgdGFibGVGaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICBsZXQgZmllbGQ6IHN0cmluZyA9IGNvbHVtbi5wcm9wZXJ0eVxyXG4gICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgIHRhYmxlRmllbGRzLnB1c2goZmllbGQpXHJcbiAgICB9XHJcbiAgfSlcclxuICByZXR1cm4gdGFibGVGaWVsZHMuZXZlcnkoKGZpZWxkOiBzdHJpbmcpID0+IGZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGltcG9ydFhMU1gocGFyYW1zOiBhbnkpIHtcclxuICBjb25zdCB7ICR0YWJsZSwgY29sdW1ucywgb3B0aW9ucywgZmlsZSB9ID0gcGFyYW1zXHJcbiAgY29uc3QgeyBfaW1wb3J0Q2FsbGJhY2sgfSA9ICR0YWJsZVxyXG4gIGNvbnN0IGZpbGVSZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpXHJcbiAgZmlsZVJlYWRlci5vbmxvYWQgPSAoZTogYW55KSA9PiB7XHJcbiAgICBjb25zdCB3b3JrYm9vayA9IFhMU1gucmVhZChlLnRhcmdldC5yZXN1bHQsIHsgdHlwZTogJ2JpbmFyeScgfSlcclxuICAgIGNvbnN0IGNzdkRhdGE6IHN0cmluZyA9IFhMU1gudXRpbHMuc2hlZXRfdG9fY3N2KHdvcmtib29rLlNoZWV0cy5TaGVldDEpXHJcbiAgICBjb25zdCByZXN0OiBhbnkgPSBwYXJzZUNzdihjb2x1bW5zLCBjc3ZEYXRhKVxyXG4gICAgY29uc3QgeyBmaWVsZHMsIHJvd3MgfSA9IHJlc3RcclxuICAgIGNvbnN0IHN0YXR1cyA9IGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zLCBmaWVsZHMsIHJvd3MpXHJcbiAgICBpZiAoc3RhdHVzKSB7XHJcbiAgICAgICR0YWJsZS5jcmVhdGVEYXRhKHJvd3MpXHJcbiAgICAgICAgLnRoZW4oKGRhdGE6IGFueVtdKSA9PiB7XHJcbiAgICAgICAgICBpZiAob3B0aW9ucy5tb2RlID09PSAnYXBwZW5kJykge1xyXG4gICAgICAgICAgICAkdGFibGUuaW5zZXJ0QXQoZGF0YSwgLTEpXHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAkdGFibGUucmVsb2FkRGF0YShkYXRhKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgIGlmIChvcHRpb25zLm1lc3NhZ2UpIHtcclxuICAgICAgICAkdGFibGUuJFhNb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogaTE4bigndnhlLnRhYmxlLmltcFN1Y2Nlc3MnKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLm1lc3NhZ2UpIHtcclxuICAgICAgJHRhYmxlLiRYTW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IGkxOG4oJ3Z4ZS5lcnJvci5pbXBGaWVsZHMnKSwgc3RhdHVzOiAnZXJyb3InIH0pXHJcbiAgICB9XHJcbiAgICBpZiAoX2ltcG9ydENhbGxiYWNrKSB7XHJcbiAgICAgIF9pbXBvcnRDYWxsYmFjayhzdGF0dXMpXHJcbiAgICB9XHJcbiAgfVxyXG4gIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUltcG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgc3dpdGNoIChwYXJhbXMub3B0aW9ucy50eXBlKSB7XHJcbiAgICBjYXNlICd4bHN4JzpcclxuICAgICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlRXhwb3J0RXZlbnQocGFyYW1zOiBhbnkpIHtcclxuICBzd2l0Y2ggKHBhcmFtcy5vcHRpb25zLnR5cGUpIHtcclxuICAgIGNhc2UgJ3hsc3gnOlxyXG4gICAgICBleHBvcnRYTFNYKHBhcmFtcylcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogeGxzeCDnrYnmoLzlvI9cclxuICovXHJcbmV4cG9ydCBjb25zdCBWWEVUYWJsZVBsdWdpbkV4cG9ydDogYW55ID0ge1xyXG4gIGluc3RhbGwoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUpIHtcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHhsc3g6IDEgfSlcclxuICAgIHh0YWJsZS5pbnRlcmNlcHRvci5taXhpbih7XHJcbiAgICAgICdldmVudC5pbXBvcnQnOiBoYW5kbGVJbXBvcnRFdmVudCxcclxuICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XHJcbiAgICB9KVxyXG4gICAgVlhFVGFibGVQbHVnaW5FeHBvcnQudCA9IHh0YWJsZS50XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpMThuKGtleTogc3RyaW5nKSB7XHJcbiAgaWYgKFZYRVRhYmxlUGx1Z2luRXhwb3J0LnQpIHtcclxuICAgIHJldHVybiBWWEVUYWJsZVBsdWdpbkV4cG9ydC50KGtleSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0KVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFxyXG4iXX0=

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _xlsx = _interopRequireDefault(require("xlsx"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
    });
  }

  var rowList = datas.map(function (row, rowIndex) {
    var item = {};
    columns.forEach(function (column, columnIndex) {
      var cellValue;
      var property = column.property;
      var isIndex = column.type === 'index';

      if (!original || isIndex) {
        cellValue = isIndex ? column.indexMethod ? column.indexMethod({
          row: row,
          rowIndex: rowIndex,
          column: column,
          columnIndex: columnIndex
        }) : rowIndex + 1 : row[column.id];
      } else {
        cellValue = _xeUtils["default"].get(row, property);
      }

      item[column.id] = cellValue;
    });
    return item;
  });

  if (isFooter) {
    var footerData = $table.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = rows[$table.$getColumnIndex(column)] || '';
      });
      footList.push(item);
    });
  }

  var book = _xlsx["default"].utils.book_new();

  var sheet = _xlsx["default"].utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  }); // 转换数据


  _xlsx["default"].utils.book_append_sheet(book, sheet, sheetName);

  var wbout = _xlsx["default"].write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });

  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  downloadFile(blob, options);

  if (message !== false) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(i18n('vxe.error.notExp'));
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').forEach(function (val) {
      var field = replaceDoubleQuotation(val);

      if (field) {
        fields.push(field);
      }
    });
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          item[fields[colIndex]] = replaceDoubleQuotation(val);
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var $table = params.$table,
      columns = params.columns,
      options = params.options,
      file = params.file;
  var _importCallback = $table._importCallback,
      _importResolve = $table._importResolve;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = _xlsx["default"].read(e.target.result, {
      type: 'binary'
    });

    var csvData = _xlsx["default"].utils.sheet_to_csv(workbook.Sheets.Sheet1);

    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message !== false) {
        $table.$XModal.message({
          message: i18n('vxe.table.impSuccess'),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      $table.$XModal.message({
        message: i18n('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importResolve) {
      _importResolve(status);

      $table._importResolve = null;
    } else if (_importCallback) {
      // 已废弃
      _importCallback(status);

      $table._importCallback = null;
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */


var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
    VXETablePluginExportXLSX.t = xtable.t;
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;

function i18n(key) {
  if (VXETablePluginExportXLSX.t) {
    return VXETablePluginExportXLSX.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}

var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRvQnVmZmVyIiwid2JvdXQiLCJidWYiLCJBcnJheUJ1ZmZlciIsImxlbmd0aCIsInZpZXciLCJVaW50OEFycmF5IiwiaW5kZXgiLCJjaGFyQ29kZUF0IiwiZXhwb3J0WExTWCIsInBhcmFtcyIsIiR0YWJsZSIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaGVldE5hbWUiLCJ0eXBlIiwiaXNIZWFkZXIiLCJpc0Zvb3RlciIsIm9yaWdpbmFsIiwibWVzc2FnZSIsImZvb3RlckZpbHRlck1ldGhvZCIsImNvbEhlYWQiLCJmb290TGlzdCIsImZvckVhY2giLCJjb2x1bW4iLCJpZCIsIlhFVXRpbHMiLCJ0b1N0cmluZyIsInByb3BlcnR5IiwiZ2V0VGl0bGUiLCJyb3dMaXN0IiwibWFwIiwicm93Iiwicm93SW5kZXgiLCJpdGVtIiwiY29sdW1uSW5kZXgiLCJjZWxsVmFsdWUiLCJpc0luZGV4IiwiaW5kZXhNZXRob2QiLCJnZXQiLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsInJvd3MiLCIkZ2V0Q29sdW1uSW5kZXgiLCJwdXNoIiwiYm9vayIsIlhMU1giLCJ1dGlscyIsImJvb2tfbmV3Iiwic2hlZXQiLCJqc29uX3RvX3NoZWV0IiwiY29uY2F0Iiwic2tpcEhlYWRlciIsImJvb2tfYXBwZW5kX3NoZWV0Iiwid3JpdGUiLCJib29rVHlwZSIsImJvb2tTU1QiLCJibG9iIiwiQmxvYiIsImRvd25sb2FkRmlsZSIsIiRYTW9kYWwiLCJpMThuIiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJkb3dubG9hZCIsImhyZWYiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJjbGljayIsInJlbW92ZUNoaWxkIiwiY29uc29sZSIsImVycm9yIiwicmVwbGFjZURvdWJsZVF1b3RhdGlvbiIsInZhbCIsInJlcGxhY2UiLCJwYXJzZUNzdiIsImNvbnRlbnQiLCJsaXN0Iiwic3BsaXQiLCJmaWVsZHMiLCJyTGlzdCIsInNsaWNlIiwiZmllbGQiLCJyIiwiY29sSW5kZXgiLCJjaGVja0ltcG9ydERhdGEiLCJ0YWJsZUZpZWxkcyIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRDYWxsYmFjayIsIl9pbXBvcnRSZXNvbHZlIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsInJlc3QiLCJjcmVhdGVEYXRhIiwidGhlbiIsImRhdGEiLCJtb2RlIiwiaW5zZXJ0QXQiLCJyZWxvYWREYXRhIiwicmVhZEFzQmluYXJ5U3RyaW5nIiwiaGFuZGxlSW1wb3J0RXZlbnQiLCJoYW5kbGVFeHBvcnRFdmVudCIsIlZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCIsImluc3RhbGwiLCJ4dGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJpbnRlcmNlcHRvciIsIm1peGluIiwidCIsImtleSIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7QUFFQSxTQUFTQSxRQUFULENBQWtCQyxLQUFsQixFQUE0QjtBQUMxQixNQUFJQyxHQUFHLEdBQUcsSUFBSUMsV0FBSixDQUFnQkYsS0FBSyxDQUFDRyxNQUF0QixDQUFWO0FBQ0EsTUFBSUMsSUFBSSxHQUFHLElBQUlDLFVBQUosQ0FBZUosR0FBZixDQUFYOztBQUNBLE9BQUssSUFBSUssS0FBSyxHQUFHLENBQWpCLEVBQW9CQSxLQUFLLEtBQUtOLEtBQUssQ0FBQ0csTUFBcEMsRUFBNEMsRUFBRUcsS0FBOUM7QUFBcURGLElBQUFBLElBQUksQ0FBQ0UsS0FBRCxDQUFKLEdBQWNO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TSxDQUFDRyxLQUFyQixFQUE0QjtBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUE1QjtBQUNBSixJQUFBQSxNQUFNLENBQUNLLFdBQVAsQ0FBbUJDLEtBQW5CLENBQXlCO0FBQ3ZCLHNCQUFnQlYsaUJBRE87QUFFdkIsc0JBQWdCQztBQUZPLEtBQXpCO0FBSUFDLElBQUFBLHdCQUF3QixDQUFDUyxDQUF6QixHQUE2QlAsTUFBTSxDQUFDTyxDQUFwQztBQUNEO0FBUjBDLENBQXRDOzs7QUFXUCxTQUFTdkUsSUFBVCxDQUFjd0UsR0FBZCxFQUF5QjtBQUN2QixNQUFJVix3QkFBd0IsQ0FBQ1MsQ0FBN0IsRUFBZ0M7QUFDOUIsV0FBT1Qsd0JBQXdCLENBQUNTLENBQXpCLENBQTJCQyxHQUEzQixDQUFQO0FBQ0Q7QUFDRjs7QUFFRCxJQUFJLE9BQU90RSxNQUFQLEtBQWtCLFdBQWxCLElBQWlDQSxNQUFNLENBQUN1RSxRQUE1QyxFQUFzRDtBQUNwRHZFLEVBQUFBLE1BQU0sQ0FBQ3VFLFFBQVAsQ0FBZ0JDLEdBQWhCLENBQW9CWix3QkFBcEI7QUFDRDs7ZUFFY0Esd0IiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IFZYRVRhYmxlIGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5pbXBvcnQgWExTWCBmcm9tICd4bHN4J1xyXG5cclxuZnVuY3Rpb24gdG9CdWZmZXIod2JvdXQ6IGFueSkge1xyXG4gIGxldCBidWYgPSBuZXcgQXJyYXlCdWZmZXIod2JvdXQubGVuZ3RoKVxyXG4gIGxldCB2aWV3ID0gbmV3IFVpbnQ4QXJyYXkoYnVmKVxyXG4gIGZvciAobGV0IGluZGV4ID0gMDsgaW5kZXggIT09IHdib3V0Lmxlbmd0aDsgKytpbmRleCkgdmlld1tpbmRleF0gPSB3Ym91dC5jaGFyQ29kZUF0KGluZGV4KSAmIDB4RkZcclxuICByZXR1cm4gYnVmXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGV4cG9ydFhMU1gocGFyYW1zOiBhbnkpIHtcclxuICBjb25zdCB7ICR0YWJsZSwgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgc2hlZXROYW1lLCB0eXBlLCBpc0hlYWRlciwgaXNGb290ZXIsIG9yaWdpbmFsLCBtZXNzYWdlLCBmb290ZXJGaWx0ZXJNZXRob2QgfSA9IG9wdGlvbnNcclxuICBjb25zdCBjb2xIZWFkOiBhbnkgPSB7fVxyXG4gIGNvbnN0IGZvb3RMaXN0OiBhbnlbXSA9IFtdXHJcbiAgaWYgKGlzSGVhZGVyKSB7XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGNvbnN0IHJvd0xpc3Q6IGFueVtdID0gZGF0YXMubWFwKChyb3c6IGFueSwgcm93SW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnksIGNvbHVtbkluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgbGV0IGNlbGxWYWx1ZVxyXG4gICAgICBjb25zdCBwcm9wZXJ0eSA9IGNvbHVtbi5wcm9wZXJ0eVxyXG4gICAgICBjb25zdCBpc0luZGV4ID0gY29sdW1uLnR5cGUgPT09ICdpbmRleCdcclxuICAgICAgaWYgKCFvcmlnaW5hbCB8fCBpc0luZGV4KSB7XHJcbiAgICAgICAgY2VsbFZhbHVlID0gaXNJbmRleCA/IChjb2x1bW4uaW5kZXhNZXRob2QgPyBjb2x1bW4uaW5kZXhNZXRob2QoeyByb3csIHJvd0luZGV4LCBjb2x1bW4sIGNvbHVtbkluZGV4IH0pIDogcm93SW5kZXggKyAxKSA6IHJvd1tjb2x1bW4uaWRdXHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2VsbFZhbHVlID0gWEVVdGlscy5nZXQocm93LCBwcm9wZXJ0eSlcclxuICAgICAgfVxyXG4gICAgICBpdGVtW2NvbHVtbi5pZF0gPSBjZWxsVmFsdWVcclxuICAgIH0pXHJcbiAgICByZXR1cm4gaXRlbVxyXG4gIH0pXHJcbiAgaWYgKGlzRm9vdGVyKSB7XHJcbiAgICBjb25zdCBmb290ZXJEYXRhOiBhbnlbXSA9ICR0YWJsZS5mb290ZXJEYXRhXHJcbiAgICBjb25zdCBmb290ZXJzOiBhbnlbXSA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhXHJcbiAgICBmb290ZXJzLmZvckVhY2goKHJvd3M6IGFueVtdKSA9PiB7XHJcbiAgICAgIGNvbnN0IGl0ZW06IGFueSA9IHt9XHJcbiAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgICAgICBpdGVtW2NvbHVtbi5pZF0gPSByb3dzWyR0YWJsZS4kZ2V0Q29sdW1uSW5kZXgoY29sdW1uKV0gfHwgJydcclxuICAgICAgfSlcclxuICAgICAgZm9vdExpc3QucHVzaChpdGVtKVxyXG4gICAgfSlcclxuICB9XHJcbiAgY29uc3QgYm9vayA9IFhMU1gudXRpbHMuYm9va19uZXcoKVxyXG4gIGNvbnN0IHNoZWV0ID0gWExTWC51dGlscy5qc29uX3RvX3NoZWV0KChpc0hlYWRlciA/IFtjb2xIZWFkXSA6IFtdKS5jb25jYXQocm93TGlzdCkuY29uY2F0KGZvb3RMaXN0KSwgeyBza2lwSGVhZGVyOiB0cnVlIH0pXHJcbiAgLy8g6L2s5o2i5pWw5o2uXHJcbiAgWExTWC51dGlscy5ib29rX2FwcGVuZF9zaGVldChib29rLCBzaGVldCwgc2hlZXROYW1lKVxyXG4gIGNvbnN0IHdib3V0ID0gWExTWC53cml0ZShib29rLCB7IGJvb2tUeXBlOiB0eXBlLCBib29rU1NUOiBmYWxzZSwgdHlwZTogJ2JpbmFyeScgfSlcclxuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RvQnVmZmVyKHdib3V0KV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScgfSlcclxuICAvLyDkv53lrZjlr7zlh7pcclxuICBkb3dubG9hZEZpbGUoYmxvYiwgb3B0aW9ucylcclxuICBpZiAobWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZG93bmxvYWRGaWxlKGJsb2I6IEJsb2IsIG9wdGlvbnM6IGFueSkge1xyXG4gIGlmICh3aW5kb3cuQmxvYikge1xyXG4gICAgY29uc3QgeyBmaWxlbmFtZSwgdHlwZSB9ID0gb3B0aW9uc1xyXG4gICAgaWYgKG5hdmlnYXRvci5tc1NhdmVCbG9iKSB7XHJcbiAgICAgIG5hdmlnYXRvci5tc1NhdmVCbG9iKGJsb2IsIGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhciBsaW5rRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKVxyXG4gICAgICBsaW5rRWxlbS50YXJnZXQgPSAnX2JsYW5rJ1xyXG4gICAgICBsaW5rRWxlbS5kb3dubG9hZCA9IGAke2ZpbGVuYW1lfS4ke3R5cGV9YFxyXG4gICAgICBsaW5rRWxlbS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmtFbGVtKVxyXG4gICAgICBsaW5rRWxlbS5jbGljaygpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGlua0VsZW0pXHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoaTE4bigndnhlLmVycm9yLm5vdEV4cCcpKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWw6IHN0cmluZykge1xyXG4gIHJldHVybiB2YWwucmVwbGFjZSgvXlwiLywgJycpLnJlcGxhY2UoL1wiJC8sICcnKVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZUNzdihjb2x1bW5zOiBhbnlbXSwgY29udGVudDogc3RyaW5nKSB7XHJcbiAgY29uc3QgbGlzdDogc3RyaW5nW10gPSBjb250ZW50LnNwbGl0KCdcXG4nKVxyXG4gIGNvbnN0IGZpZWxkczogYW55W10gPSBbXVxyXG4gIGNvbnN0IHJvd3M6IGFueVtdID0gW11cclxuICBpZiAobGlzdC5sZW5ndGgpIHtcclxuICAgIGNvbnN0IHJMaXN0OiBzdHJpbmdbXSA9IGxpc3Quc2xpY2UoMSlcclxuICAgIGxpc3RbMF0uc3BsaXQoJywnKS5mb3JFYWNoKCh2YWw6IHN0cmluZykgPT4ge1xyXG4gICAgICBjb25zdCBmaWVsZDogc3RyaW5nID0gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWwpXHJcbiAgICAgIGlmIChmaWVsZCkge1xyXG4gICAgICAgIGZpZWxkcy5wdXNoKGZpZWxkKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gICAgckxpc3QuZm9yRWFjaCgocjogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgICAgICByLnNwbGl0KCcsJykuZm9yRWFjaCgodmFsOiBzdHJpbmcsIGNvbEluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgIGl0ZW1bZmllbGRzW2NvbEluZGV4XV0gPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbClcclxuICAgICAgICB9KVxyXG4gICAgICAgIHJvd3MucHVzaChpdGVtKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuICByZXR1cm4geyBmaWVsZHMsIHJvd3MgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja0ltcG9ydERhdGEoY29sdW1uczogYW55W10sIGZpZWxkczogc3RyaW5nW10sIHJvd3M6IGFueVtdKSB7XHJcbiAgbGV0IHRhYmxlRmllbGRzOiBzdHJpbmdbXSA9IFtdXHJcbiAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgbGV0IGZpZWxkOiBzdHJpbmcgPSBjb2x1bW4ucHJvcGVydHlcclxuICAgIGlmIChmaWVsZCkge1xyXG4gICAgICB0YWJsZUZpZWxkcy5wdXNoKGZpZWxkKVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgcmV0dXJuIHRhYmxlRmllbGRzLmV2ZXJ5KChmaWVsZDogc3RyaW5nKSA9PiBmaWVsZHMuaW5jbHVkZXMoZmllbGQpKVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbXBvcnRYTFNYKHBhcmFtczogYW55KSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIGNvbHVtbnMsIG9wdGlvbnMsIGZpbGUgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgX2ltcG9ydENhbGxiYWNrLCBfaW1wb3J0UmVzb2x2ZSB9ID0gJHRhYmxlXHJcbiAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICBmaWxlUmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkKGUudGFyZ2V0LnJlc3VsdCwgeyB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gICAgY29uc3QgY3N2RGF0YTogc3RyaW5nID0gWExTWC51dGlscy5zaGVldF90b19jc3Yod29ya2Jvb2suU2hlZXRzLlNoZWV0MSlcclxuICAgIGNvbnN0IHJlc3Q6IGFueSA9IHBhcnNlQ3N2KGNvbHVtbnMsIGNzdkRhdGEpXHJcbiAgICBjb25zdCB7IGZpZWxkcywgcm93cyB9ID0gcmVzdFxyXG4gICAgY29uc3Qgc3RhdHVzID0gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnMsIGZpZWxkcywgcm93cylcclxuICAgIGlmIChzdGF0dXMpIHtcclxuICAgICAgJHRhYmxlLmNyZWF0ZURhdGEocm93cylcclxuICAgICAgICAudGhlbigoZGF0YTogYW55W10pID0+IHtcclxuICAgICAgICAgIGlmIChvcHRpb25zLm1vZGUgPT09ICdhcHBlbmQnKSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5pbnNlcnRBdChkYXRhLCAtMSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5yZWxvYWREYXRhKGRhdGEpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAkdGFibGUuJFhNb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogaTE4bigndnhlLnRhYmxlLmltcFN1Y2Nlc3MnKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUuZXJyb3IuaW1wRmllbGRzJyksIHN0YXR1czogJ2Vycm9yJyB9KVxyXG4gICAgfVxyXG4gICAgaWYgKF9pbXBvcnRSZXNvbHZlKSB7XHJcbiAgICAgIF9pbXBvcnRSZXNvbHZlKHN0YXR1cylcclxuICAgICAgJHRhYmxlLl9pbXBvcnRSZXNvbHZlID0gbnVsbFxyXG4gICAgfSBlbHNlIGlmIChfaW1wb3J0Q2FsbGJhY2spIHtcclxuICAgICAgLy8g5bey5bqf5byDXHJcbiAgICAgIF9pbXBvcnRDYWxsYmFjayhzdGF0dXMpXHJcbiAgICAgICR0YWJsZS5faW1wb3J0Q2FsbGJhY2sgPSBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG4gIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUltcG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgZXhwb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWDogYW55ID0ge1xyXG4gIGluc3RhbGwoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUpIHtcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHhsc3g6IDEgfSlcclxuICAgIHh0YWJsZS5pbnRlcmNlcHRvci5taXhpbih7XHJcbiAgICAgICdldmVudC5pbXBvcnQnOiBoYW5kbGVJbXBvcnRFdmVudCxcclxuICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XHJcbiAgICB9KVxyXG4gICAgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYLnQgPSB4dGFibGUudFxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaTE4bihrZXk6IHN0cmluZykge1xyXG4gIGlmIChWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gudCkge1xyXG4gICAgcmV0dXJuIFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWC50KGtleSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWClcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYXHJcbiJdfQ==

"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExport = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var XLSX = _interopRequireWildcard(require("xlsx"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      original = options.original;
  var colHead = {};

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = original ? column.property : column.getTitle();
    });
  }

  var rowList = datas.map(function (row) {
    var item = {};
    columns.forEach(function (column) {
      item[column.id] = original ? _xeUtils["default"].get(row, column.property) : row[column.id];
    });
    return item;
  });
  var book = XLSX.utils.book_new();
  var sheet = XLSX.utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList), {
    skipHeader: true
  }); // 转换数据

  XLSX.utils.book_append_sheet(book, sheet, sheetName);
  var wbout = XLSX.write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });
  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  download(blob, options);
}

function download(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, filename);
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error('[vxe-table-plugin-export] The current environment does not support exports.');
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').forEach(function (val) {
      var field = replaceDoubleQuotation(val);

      if (field) {
        fields.push(field);
      }
    });
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          item[fields[colIndex]] = replaceDoubleQuotation(val);
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params, evnt) {
  var $table = params.$table,
      columns = params.columns;
  var importCallback = $table.importCallback;
  var file = evnt.target.files[0];
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = XLSX.read(e.target.result, {
      type: 'binary'
    });
    var csvData = XLSX.utils.sheet_to_csv(workbook.Sheets.Sheet1);
    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        return $table.reloadData(data);
      });
    }

    if (importCallback) {
      importCallback(status);
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params, evnt) {
  switch (params.options.type) {
    case 'xlsx':
      importXLSX(params, evnt);
      return false;
  }
}

function handleExportEvent(params) {
  switch (params.options.type) {
    case 'xlsx':
      exportXLSX(params);
      return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 等格式
 */


var VXETablePluginExport = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
  }
};
exports.VXETablePluginExport = VXETablePluginExport;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExport);
}

var _default = VXETablePluginExport;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRvQnVmZmVyIiwid2JvdXQiLCJidWYiLCJBcnJheUJ1ZmZlciIsImxlbmd0aCIsInZpZXciLCJVaW50OEFycmF5IiwiaW5kZXgiLCJjaGFyQ29kZUF0IiwiZXhwb3J0WExTWCIsInBhcmFtcyIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaGVldE5hbWUiLCJ0eXBlIiwiaXNIZWFkZXIiLCJvcmlnaW5hbCIsImNvbEhlYWQiLCJmb3JFYWNoIiwiY29sdW1uIiwiaWQiLCJwcm9wZXJ0eSIsImdldFRpdGxlIiwicm93TGlzdCIsIm1hcCIsInJvdyIsIml0ZW0iLCJYRVV0aWxzIiwiZ2V0IiwiYm9vayIsIlhMU1giLCJ1dGlscyIsImJvb2tfbmV3Iiwic2hlZXQiLCJqc29uX3RvX3NoZWV0IiwiY29uY2F0Iiwic2tpcEhlYWRlciIsImJvb2tfYXBwZW5kX3NoZWV0Iiwid3JpdGUiLCJib29rVHlwZSIsImJvb2tTU1QiLCJibG9iIiwiQmxvYiIsImRvd25sb2FkIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsImNvbnNvbGUiLCJlcnJvciIsInJlcGxhY2VEb3VibGVRdW90YXRpb24iLCJ2YWwiLCJyZXBsYWNlIiwicGFyc2VDc3YiLCJjb250ZW50IiwibGlzdCIsInNwbGl0IiwiZmllbGRzIiwicm93cyIsInJMaXN0Iiwic2xpY2UiLCJmaWVsZCIsInB1c2giLCJyIiwiY29sSW5kZXgiLCJjaGVja0ltcG9ydERhdGEiLCJ0YWJsZUZpZWxkcyIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZXZudCIsIiR0YWJsZSIsImltcG9ydENhbGxiYWNrIiwiZmlsZSIsImZpbGVzIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsInJlc3QiLCJzdGF0dXMiLCJjcmVhdGVEYXRhIiwidGhlbiIsImRhdGEiLCJyZWxvYWREYXRhIiwicmVhZEFzQmluYXJ5U3RyaW5nIiwiaGFuZGxlSW1wb3J0RXZlbnQiLCJoYW5kbGVFeHBvcnRFdmVudCIsIlZYRVRhYmxlUGx1Z2luRXhwb3J0IiwiaW5zdGFsbCIsInh0YWJsZSIsIk9iamVjdCIsImFzc2lnbiIsInR5cGVzIiwieGxzeCIsImludGVyY2VwdG9yIiwibWl4aW4iLCJWWEVUYWJsZSIsInVzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOzs7Ozs7OztBQUVBLFNBQVNBLFFBQVQsQ0FBa0JDLEtBQWxCLEVBQTRCO0FBQzFCLE1BQUlDLEdBQUcsR0FBRyxJQUFJQyxXQUFKLENBQWdCRixLQUFLLENBQUNHLE1BQXRCLENBQVY7QUFDQSxNQUFJQyxJQUFJLEdBQUcsSUFBSUMsVUFBSixDQUFlSixHQUFmLENBQVg7O0FBQ0EsT0FBSyxJQUFJSyxLQUFLLEdBQUcsQ0FBakIsRUFBb0JBLEtBQUssS0FBS04sS0FBSyxDQUFDRyxNQUFwQyxFQUE0QyxFQUFFRyxLQUE5QztBQUFxREYsSUFBQUEsSUFBSSxDQUFDRSxLQUFELENBQUosR0FBY04sS0FBSyxDQUFDTyxVQUFOLENBQWlCRCxLQUFqQixJQUEwQixJQUF4QztBQUFyRDs7QUFDQSxTQUFPTCxHQUFQO0FBQ0Q7O0FBRUQsU0FBU08sVUFBVCxDQUFvQkMsTUFBcEIsRUFBK0I7QUFBQSxNQUNyQkMsT0FEcUIsR0FDT0QsTUFEUCxDQUNyQkMsT0FEcUI7QUFBQSxNQUNaQyxPQURZLEdBQ09GLE1BRFAsQ0FDWkUsT0FEWTtBQUFBLE1BQ0hDLEtBREcsR0FDT0gsTUFEUCxDQUNIRyxLQURHO0FBQUEsTUFFckJDLFNB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LElBQTlCO0FBQ0Q7O0FBRUQsU0FBU29CLGlCQUFULENBQTJCL0YsTUFBM0IsRUFBd0N3RSxJQUF4QyxFQUFpRDtBQUMvQyxVQUFReEUsTUFBTSxDQUFDQyxPQUFQLENBQWVJLElBQXZCO0FBQ0UsU0FBSyxNQUFMO0FBQ0VrRSxNQUFBQSxVQUFVLENBQUN2RSxNQUFELEVBQVN3RSxJQUFULENBQVY7QUFDQSxhQUFPLEtBQVA7QUFISjtBQUtEOztBQUVELFNBQVN3QixpQkFBVCxDQUEyQmhHLE1BQTNCLEVBQXNDO0FBQ3BDLFVBQVFBLE1BQU0sQ0FBQ0MsT0FBUCxDQUFlSSxJQUF2QjtBQUNFLFNBQUssTUFBTDtBQUNFTixNQUFBQSxVQUFVLENBQUNDLE1BQUQsQ0FBVjtBQUNBLGFBQU8sS0FBUDtBQUhKO0FBS0Q7QUFFRDs7Ozs7QUFHTyxJQUFNaUcsb0JBQW9CLEdBQUc7QUFDbENDLEVBQUFBLE9BRGtDLG1CQUMxQkMsTUFEMEIsRUFDSDtBQUM3QkMsSUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNGLE1BQU0sQ0FBQ0csS0FBckIsRUFBNEI7QUFBRUMsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBNUI7QUFDQUosSUFBQUEsTUFBTSxDQUFDSyxXQUFQLENBQW1CQyxLQUFuQixDQUF5QjtBQUN2QixzQkFBZ0JWLGlCQURPO0FBRXZCLHNCQUFnQkM7QUFGTyxLQUF6QjtBQUlEO0FBUGlDLENBQTdCOzs7QUFVUCxJQUFJLE9BQU83RCxNQUFQLEtBQWtCLFdBQWxCLElBQWlDQSxNQUFNLENBQUN1RSxRQUE1QyxFQUFzRDtBQUNwRHZFLEVBQUFBLE1BQU0sQ0FBQ3VFLFFBQVAsQ0FBZ0JDLEdBQWhCLENBQW9CVixvQkFBcEI7QUFDRDs7ZUFFY0Esb0IiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IFZYRVRhYmxlIGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gJ3hsc3gnXHJcblxyXG5mdW5jdGlvbiB0b0J1ZmZlcih3Ym91dDogYW55KSB7XHJcbiAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpXHJcbiAgbGV0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpXHJcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCAhPT0gd2JvdXQubGVuZ3RoOyArK2luZGV4KSB2aWV3W2luZGV4XSA9IHdib3V0LmNoYXJDb2RlQXQoaW5kZXgpICYgMHhGRlxyXG4gIHJldHVybiBidWZcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0WExTWChwYXJhbXM6IGFueSkge1xyXG4gIGNvbnN0IHsgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgc2hlZXROYW1lLCB0eXBlLCBpc0hlYWRlciwgb3JpZ2luYWwgfSA9IG9wdGlvbnNcclxuICBjb25zdCBjb2xIZWFkOiBhbnkgPSB7fVxyXG4gIGlmIChpc0hlYWRlcikge1xyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICBjb2xIZWFkW2NvbHVtbi5pZF0gPSBvcmlnaW5hbCA/IGNvbHVtbi5wcm9wZXJ0eSA6IGNvbHVtbi5nZXRUaXRsZSgpXHJcbiAgICB9KVxyXG4gIH1cclxuICBjb25zdCByb3dMaXN0ID0gZGF0YXMubWFwKChyb3c6IGFueSkgPT4ge1xyXG4gICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgICAgaXRlbVtjb2x1bW4uaWRdID0gb3JpZ2luYWwgPyBYRVV0aWxzLmdldChyb3csIGNvbHVtbi5wcm9wZXJ0eSkgOiByb3dbY29sdW1uLmlkXVxyXG4gICAgfSlcclxuICAgIHJldHVybiBpdGVtXHJcbiAgfSlcclxuICBjb25zdCBib29rID0gWExTWC51dGlscy5ib29rX25ldygpXHJcbiAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KSwgeyBza2lwSGVhZGVyOiB0cnVlIH0pXHJcbiAgLy8g6L2s5o2i5pWw5o2uXHJcbiAgWExTWC51dGlscy5ib29rX2FwcGVuZF9zaGVldChib29rLCBzaGVldCwgc2hlZXROYW1lKVxyXG4gIGNvbnN0IHdib3V0ID0gWExTWC53cml0ZShib29rLCB7IGJvb2tUeXBlOiB0eXBlLCBib29rU1NUOiBmYWxzZSwgdHlwZTogJ2JpbmFyeScgfSlcclxuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RvQnVmZmVyKHdib3V0KV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScgfSlcclxuICAvLyDkv53lrZjlr7zlh7pcclxuICBkb3dubG9hZChibG9iLCBvcHRpb25zKVxyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZChibG9iOiBCbG9iLCBvcHRpb25zOiBhbnkpIHtcclxuICBpZiAod2luZG93LkJsb2IpIHtcclxuICAgIGNvbnN0IHsgZmlsZW5hbWUsIHR5cGUgfSA9IG9wdGlvbnNcclxuICAgIGlmIChuYXZpZ2F0b3IubXNTYXZlQmxvYikge1xyXG4gICAgICBuYXZpZ2F0b3IubXNTYXZlQmxvYihibG9iLCBmaWxlbmFtZSlcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhciBsaW5rRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKVxyXG4gICAgICBsaW5rRWxlbS50YXJnZXQgPSAnX2JsYW5rJ1xyXG4gICAgICBsaW5rRWxlbS5kb3dubG9hZCA9IGAke2ZpbGVuYW1lfS4ke3R5cGV9YFxyXG4gICAgICBsaW5rRWxlbS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmtFbGVtKVxyXG4gICAgICBsaW5rRWxlbS5jbGljaygpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGlua0VsZW0pXHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoJ1t2eGUtdGFibGUtcGx1Z2luLWV4cG9ydF0gVGhlIGN1cnJlbnQgZW52aXJvbm1lbnQgZG9lcyBub3Qgc3VwcG9ydCBleHBvcnRzLicpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbDogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIHZhbC5yZXBsYWNlKC9eXCIvLCAnJykucmVwbGFjZSgvXCIkLywgJycpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3N2KGNvbHVtbnM6IGFueVtdLCBjb250ZW50OiBzdHJpbmcpIHtcclxuICBjb25zdCBsaXN0OiBzdHJpbmdbXSA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpXHJcbiAgY29uc3QgZmllbGRzOiBhbnlbXSA9IFtdXHJcbiAgY29uc3Qgcm93czogYW55W10gPSBbXVxyXG4gIGlmIChsaXN0Lmxlbmd0aCkge1xyXG4gICAgY29uc3Qgckxpc3Q6IHN0cmluZ1tdID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLmZvckVhY2goKHZhbDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGNvbnN0IGZpZWxkOiBzdHJpbmcgPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbClcclxuICAgICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgICAgZmllbGRzLnB1c2goZmllbGQpXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgICByTGlzdC5mb3JFYWNoKChyOiBzdHJpbmcpID0+IHtcclxuICAgICAgaWYgKHIpIHtcclxuICAgICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICAgIHIuc3BsaXQoJywnKS5mb3JFYWNoKCh2YWw6IHN0cmluZywgY29sSW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgaXRlbVtmaWVsZHNbY29sSW5kZXhdXSA9IHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsKVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcm93cy5wdXNoKGl0ZW0pXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG4gIHJldHVybiB7IGZpZWxkcywgcm93cyB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrSW1wb3J0RGF0YShjb2x1bW5zOiBhbnlbXSwgZmllbGRzOiBzdHJpbmdbXSwgcm93czogYW55W10pIHtcclxuICBsZXQgdGFibGVGaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICBsZXQgZmllbGQ6IHN0cmluZyA9IGNvbHVtbi5wcm9wZXJ0eVxyXG4gICAgaWYgKGZpZWxkKSB7XHJcbiAgICAgIHRhYmxlRmllbGRzLnB1c2goZmllbGQpXHJcbiAgICB9XHJcbiAgfSlcclxuICByZXR1cm4gdGFibGVGaWVsZHMuZXZlcnkoKGZpZWxkOiBzdHJpbmcpID0+IGZpZWxkcy5pbmNsdWRlcyhmaWVsZCkpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGltcG9ydFhMU1gocGFyYW1zOiBhbnksIGV2bnQ6IGFueSkge1xyXG4gIGNvbnN0IHsgJHRhYmxlLCBjb2x1bW5zIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IGltcG9ydENhbGxiYWNrIH0gPSAkdGFibGVcclxuICBjb25zdCBmaWxlID0gZXZudC50YXJnZXQuZmlsZXNbMF1cclxuICBjb25zdCBmaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxyXG4gIGZpbGVSZWFkZXIub25sb2FkID0gKGU6IGFueSkgPT4ge1xyXG4gICAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZS50YXJnZXQucmVzdWx0LCB7IHR5cGU6ICdiaW5hcnknIH0pXHJcbiAgICBjb25zdCBjc3ZEYXRhOiBzdHJpbmcgPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2Nzdih3b3JrYm9vay5TaGVldHMuU2hlZXQxKVxyXG4gICAgY29uc3QgcmVzdDogYW55ID0gcGFyc2VDc3YoY29sdW1ucywgY3N2RGF0YSlcclxuICAgIGNvbnN0IHsgZmllbGRzLCByb3dzIH0gPSByZXN0XHJcbiAgICBjb25zdCBzdGF0dXMgPSBjaGVja0ltcG9ydERhdGEoY29sdW1ucywgZmllbGRzLCByb3dzKVxyXG4gICAgaWYgKHN0YXR1cykge1xyXG4gICAgICAkdGFibGUuY3JlYXRlRGF0YShyb3dzKVxyXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnlbXSkgPT4gJHRhYmxlLnJlbG9hZERhdGEoZGF0YSkpXHJcbiAgICB9XHJcbiAgICBpZiAoaW1wb3J0Q2FsbGJhY2spIHtcclxuICAgICAgaW1wb3J0Q2FsbGJhY2soc3RhdHVzKVxyXG4gICAgfVxyXG4gIH1cclxuICBmaWxlUmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhmaWxlKVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVJbXBvcnRFdmVudChwYXJhbXM6IGFueSwgZXZudDogYW55KSB7XHJcbiAgc3dpdGNoIChwYXJhbXMub3B0aW9ucy50eXBlKSB7XHJcbiAgICBjYXNlICd4bHN4JzpcclxuICAgICAgaW1wb3J0WExTWChwYXJhbXMsIGV2bnQpXHJcbiAgICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlRXhwb3J0RXZlbnQocGFyYW1zOiBhbnkpIHtcclxuICBzd2l0Y2ggKHBhcmFtcy5vcHRpb25zLnR5cGUpIHtcclxuICAgIGNhc2UgJ3hsc3gnOlxyXG4gICAgICBleHBvcnRYTFNYKHBhcmFtcylcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogeGxzeCDnrYnmoLzlvI9cclxuICovXHJcbmV4cG9ydCBjb25zdCBWWEVUYWJsZVBsdWdpbkV4cG9ydCA9IHtcclxuICBpbnN0YWxsKHh0YWJsZTogdHlwZW9mIFZYRVRhYmxlKSB7XHJcbiAgICBPYmplY3QuYXNzaWduKHh0YWJsZS50eXBlcywgeyB4bHN4OiAxIH0pXHJcbiAgICB4dGFibGUuaW50ZXJjZXB0b3IubWl4aW4oe1xyXG4gICAgICAnZXZlbnQuaW1wb3J0JzogaGFuZGxlSW1wb3J0RXZlbnQsXHJcbiAgICAgICdldmVudC5leHBvcnQnOiBoYW5kbGVFeHBvcnRFdmVudFxyXG4gICAgfSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0KVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFxyXG4iXX0=

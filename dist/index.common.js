"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _xlsx = _interopRequireDefault(require("xlsx"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

/* eslint-disable no-unused-vars */

/* eslint-enable no-unused-vars */
var _vxetable;

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  var rowList = datas;
  var sheetCols = [];

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
      sheetCols.push({
        wpx: column.renderWidth
      });
    });
  }

  if (isFooter) {
    var _$table$getTableData = $table.getTableData(),
        footerData = _$table$getTableData.footerData;

    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var book = _xlsx["default"].utils.book_new();

  var sheet = _xlsx["default"].utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  }); // 列宽


  sheet['!cols'] = sheetCols; // 转换数据

  _xlsx["default"].utils.book_append_sheet(book, sheet, sheetName);

  var wbout = _xlsx["default"].write(book, {
    bookType: 'xlsx',
    bookSST: false,
    type: 'binary'
  });

  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  downloadFile(blob, options);

  if (message !== false) {
    _vxetable.modal.message({
      message: _vxetable.t('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(_vxetable.t('vxe.error.notExp'));
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').map(replaceDoubleQuotation);
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          if (fields[colIndex]) {
            item[fields[colIndex]] = replaceDoubleQuotation(val);
          }
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var columns = params.columns,
      options = params.options,
      file = params.file;
  var $table = params.$table;
  var _importResolve = $table._importResolve;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = _xlsx["default"].read(e.target.result, {
      type: 'binary'
    });

    var csvData = _xlsx["default"].utils.sheet_to_csv(workbook.Sheets.Sheet1);

    var _parseCsv = parseCsv(columns, csvData),
        fields = _parseCsv.fields,
        rows = _parseCsv.rows;

    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message !== false) {
        _vxetable.modal.message({
          message: _xeUtils["default"].template(_vxetable.t('vxe.table.impSuccess'), [rows.length]),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      _vxetable.modal.message({
        message: _vxetable.t('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importResolve) {
      _importResolve(status);

      $table._importResolve = null;
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */


var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    var interceptor = xtable.interceptor;
    _vxetable = xtable;
    Object.assign(xtable.types, {
      xlsx: 1
    });
    interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}

var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbIl92eGV0YWJsZSIsImdldEZvb3RlckNlbGxWYWx1ZSIsIiR0YWJsZSIsIm9wdHMiLCJyb3dzIiwiY29sdW1uIiwiY2VsbFZhbHVlIiwiWEVVdGlscyIsInRvU3RyaW5nIiwiJGdldENvbHVtbkluZGV4IiwidG9CdWZmZXIiLCJ3Ym91dCIsImJ1ZiIsIkFycmF5QnVmZmVyIiwibGVuZ3RoIiwidmlldyIsIlVpbnQ4QXJyYXkiLCJpbmRleCIsImNoYXJDb2RlQXQiLCJleHBvcnRYTFNYIiwicGFyYW1zIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNoZWV0TmFtZSIsImlzSGVhZGVyIiwiaXNGb290ZXIiLCJvcmlnaW5hbCIsIm1lc3NhZ2UiLCJmb290ZXJGaWx0ZXJNZXRob2QiLCJjb2xIZWFkIiwiZm9vdExpc3QiLCJyb3dMaXN0Iiwic2hlZXRDb2xzIiwiZm9yRWFjaCIsImlkIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInB1c2giLCJ3cHgiLCJyZW5kZXJXaWR0aCIsImdldFRhYmxlRGF0YSIsImZvb3RlckRhdGEiLCJmb290ZXJzIiwiZmlsdGVyIiwiaXRlbSIsImJvb2siLCJYTFNYIiwidXRpbHMiLCJib29rX25ldyIsInNoZWV0IiwianNvbl90b19zaGVldCIsImNvbmNhdCIsInNraXBIZWFkZXIiLCJib29rX2FwcGVuZF9zaGVldCIsIndyaXRlIiwiYm9va1R5cGUiLCJib29rU1NUIiwidHlwZSIsImJsb2IiLCJCbG9iIiwiZG93bmxvYWRGaWxlIiwibW9kYWwiLCJ0Iiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJkb3dubG9hZCIsImhyZWYiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJjbGljayIsInJlbW92ZUNoaWxkIiwiY29uc29sZSIsImVycm9yIiwicmVwbGFjZURvdWJsZVF1b3RhdGlvbiIsInZhbCIsInJlcGxhY2UiLCJwYXJzZUNzdiIsImNvbnRlbnQiLCJsaXN0Iiwic3BsaXQiLCJmaWVsZHMiLCJyTGlzdCIsInNsaWNlIiwibWFwIiwiciIsImNvbEluZGV4IiwiY2hlY2tJbXBvcnREYXRhIiwidGFibGVGaWVsZHMiLCJmaWVsZCIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRSZXNvbHZlIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsImNyZWF0ZURhdGEiLCJ0aGVuIiwiZGF0YSIsIm1vZGUiLCJpbnNlcnRBdCIsInJlbG9hZERhdGEiLCJ0ZW1wbGF0ZSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1giLCJpbnN0YWxsIiwieHRhYmxlIiwiaW50ZXJjZXB0b3IiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJtaXhpbiIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0E7O0FBU0E7Ozs7QUFWQTs7QUFXQTtBQUVBLElBQUlBLFNBQUo7O0FBRUEsU0FBU0Msa0JBQVQsQ0FBNkJDLE1BQTdCLEVBQTRDQyxJQUE1QyxFQUFnRUMsSUFBaEUsRUFBNkVDLE1BQTdFLEVBQWlHO0FBQy9GLE1BQU1DLFNBQVMsR0FBR0Msb0JBQVFDLFFBQVIsQ0FBaUJKLElBQUksQ0FBQ0YsTUFBTSxDQUFDTyxlQUFQLENBQXVCSixNQUF2QixDQUFELENBQXJCLENBQWxCOztBQUNBLFNBQU9DLFNBQVA7QUFDRDs7QUFFRCxTQUFTSSxRQUFULENBQW1CQyxLQUFuQixFQUE2QjtBQUMzQixNQUFNQyxH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TUFBNUIsRUFBMkQ7QUFDekQsTUFBSUEsTUFBTSxDQUFDQyxPQUFQLENBQWVxQyxJQUFmLEtBQXdCLE1BQTVCLEVBQW9DO0FBQ2xDMkMsSUFBQUEsVUFBVSxDQUFDakYsTUFBRCxDQUFWO0FBQ0EsV0FBTyxLQUFQO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTd0csaUJBQVQsQ0FBNEJ4RyxNQUE1QixFQUEyRDtBQUN6RCxNQUFJQSxNQUFNLENBQUNDLE9BQVAsQ0FBZXFDLElBQWYsS0FBd0IsTUFBNUIsRUFBb0M7QUFDbEN2QyxJQUFBQSxVQUFVLENBQUNDLE1BQUQsQ0FBVjtBQUNBLFdBQU8sS0FBUDtBQUNEO0FBQ0Y7QUFFRDs7Ozs7QUFHTyxJQUFNeUcsd0JBQXdCLEdBQUc7QUFDdENDLEVBQUFBLE9BRHNDLG1CQUM3QkMsTUFENkIsRUFDTjtBQUFBLFFBQ3RCQyxXQURzQixHQUNORCxNQURNLENBQ3RCQyxXQURzQjtBQUU5QmhJLElBQUFBLFNBQVMsR0FBRytILE1BQVo7QUFDQUUsSUFBQUEsTUFBTSxDQUFDQyxNQUFQLENBQWNILE1BQU0sQ0FBQ0ksS0FBckIsRUFBNEI7QUFBRUMsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBNUI7QUFDQUosSUFBQUEsV0FBVyxDQUFDSyxLQUFaLENBQWtCO0FBQ2hCLHNCQUFnQlYsaUJBREE7QUFFaEIsc0JBQWdCQztBQUZBLEtBQWxCO0FBSUQ7QUFUcUMsQ0FBakM7OztBQVlQLElBQUksT0FBTzNELE1BQVAsS0FBa0IsV0FBbEIsSUFBaUNBLE1BQU0sQ0FBQ3FFLFFBQTVDLEVBQXNEO0FBQ3BEckUsRUFBQUEsTUFBTSxDQUFDcUUsUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JWLHdCQUFwQjtBQUNEOztlQUVjQSx3QiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiBlc2xpbnQtZGlzYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5pbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQge1xyXG4gIFZYRVRhYmxlLFxyXG4gIFRhYmxlLFxyXG4gIEludGVyY2VwdG9yRXhwb3J0UGFyYW1zLFxyXG4gIEludGVyY2VwdG9ySW1wb3J0UGFyYW1zLFxyXG4gIENvbHVtbkNvbmZpZyxcclxuICBFeHBvcnRPcHRvbnNcclxufSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IFhMU1ggZnJvbSAneGxzeCdcclxuLyogZXNsaW50LWVuYWJsZSBuby11bnVzZWQtdmFycyAqL1xyXG5cclxubGV0IF92eGV0YWJsZTogdHlwZW9mIFZYRVRhYmxlXHJcblxyXG5mdW5jdGlvbiBnZXRGb290ZXJDZWxsVmFsdWUgKCR0YWJsZTogVGFibGUsIG9wdHM6IEV4cG9ydE9wdG9ucywgcm93czogYW55W10sIGNvbHVtbjogQ29sdW1uQ29uZmlnKSB7XHJcbiAgY29uc3QgY2VsbFZhbHVlID0gWEVVdGlscy50b1N0cmluZyhyb3dzWyR0YWJsZS4kZ2V0Q29sdW1uSW5kZXgoY29sdW1uKV0pXHJcbiAgcmV0dXJuIGNlbGxWYWx1ZVxyXG59XHJcblxyXG5mdW5jdGlvbiB0b0J1ZmZlciAod2JvdXQ6IGFueSkge1xyXG4gIGNvbnN0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpXHJcbiAgY29uc3QgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZilcclxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4ICE9PSB3Ym91dC5sZW5ndGg7ICsraW5kZXgpIHZpZXdbaW5kZXhdID0gd2JvdXQuY2hhckNvZGVBdChpbmRleCkgJiAweEZGXHJcbiAgcmV0dXJuIGJ1ZlxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRYTFNYIChwYXJhbXM6IEludGVyY2VwdG9yRXhwb3J0UGFyYW1zKSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IHNoZWV0TmFtZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgbWVzc2FnZSwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgY29sSGVhZDogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9XHJcbiAgY29uc3QgZm9vdExpc3Q6IHsgW2tleTogc3RyaW5nXTogYW55IH1bXSA9IFtdXHJcbiAgY29uc3Qgcm93TGlzdCA9IGRhdGFzXHJcbiAgY29uc3Qgc2hlZXRDb2xzOiBhbnlbXSA9IFtdXHJcbiAgaWYgKGlzSGVhZGVyKSB7XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgICBjb2xIZWFkW2NvbHVtbi5pZF0gPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpXHJcbiAgICAgIHNoZWV0Q29scy5wdXNoKHtcclxuICAgICAgICB3cHg6IGNvbHVtbi5yZW5kZXJXaWR0aFxyXG4gICAgICB9KVxyXG4gICAgfSlcclxuICB9XHJcbiAgaWYgKGlzRm9vdGVyKSB7XHJcbiAgICBjb25zdCB7IGZvb3RlckRhdGEgfSA9ICR0YWJsZS5nZXRUYWJsZURhdGEoKVxyXG4gICAgY29uc3QgZm9vdGVycyA9IGZvb3RlckZpbHRlck1ldGhvZCA/IGZvb3RlckRhdGEuZmlsdGVyKGZvb3RlckZpbHRlck1ldGhvZCkgOiBmb290ZXJEYXRhXHJcbiAgICBmb290ZXJzLmZvckVhY2goKHJvd3MpID0+IHtcclxuICAgICAgY29uc3QgaXRlbTogeyBba2V5OiBzdHJpbmddOiBhbnkgfSA9IHt9XHJcbiAgICAgIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uKSA9PiB7XHJcbiAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gZ2V0Rm9vdGVyQ2VsbFZhbHVlKCR0YWJsZSwgb3B0aW9ucywgcm93cywgY29sdW1uKVxyXG4gICAgICB9KVxyXG4gICAgICBmb290TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH1cclxuICBjb25zdCBib29rID0gWExTWC51dGlscy5ib29rX25ldygpXHJcbiAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSlcclxuICAvLyDliJflrr1cclxuICBzaGVldFsnIWNvbHMnXSA9IHNoZWV0Q29sc1xyXG4gIC8vIOi9rOaNouaVsOaNrlxyXG4gIFhMU1gudXRpbHMuYm9va19hcHBlbmRfc2hlZXQoYm9vaywgc2hlZXQsIHNoZWV0TmFtZSlcclxuICBjb25zdCB3Ym91dCA9IFhMU1gud3JpdGUoYm9vaywgeyBib29rVHlwZTogJ3hsc3gnLCBib29rU1NUOiBmYWxzZSwgdHlwZTogJ2JpbmFyeScgfSlcclxuICBjb25zdCBibG9iID0gbmV3IEJsb2IoW3RvQnVmZmVyKHdib3V0KV0sIHsgdHlwZTogJ2FwcGxpY2F0aW9uL29jdGV0LXN0cmVhbScgfSlcclxuICAvLyDkv53lrZjlr7zlh7pcclxuICBkb3dubG9hZEZpbGUoYmxvYiwgb3B0aW9ucylcclxuICBpZiAobWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgIF92eGV0YWJsZS5tb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZEZpbGUgKGJsb2I6IEJsb2IsIG9wdGlvbnM6IEV4cG9ydE9wdG9ucykge1xyXG4gIGlmICh3aW5kb3cuQmxvYikge1xyXG4gICAgY29uc3QgeyBmaWxlbmFtZSwgdHlwZSB9ID0gb3B0aW9uc1xyXG4gICAgaWYgKG5hdmlnYXRvci5tc1NhdmVCbG9iKSB7XHJcbiAgICAgIG5hdmlnYXRvci5tc1NhdmVCbG9iKGJsb2IsIGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNvbnN0IGxpbmtFbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpXHJcbiAgICAgIGxpbmtFbGVtLnRhcmdldCA9ICdfYmxhbmsnXHJcbiAgICAgIGxpbmtFbGVtLmRvd25sb2FkID0gYCR7ZmlsZW5hbWV9LiR7dHlwZX1gXHJcbiAgICAgIGxpbmtFbGVtLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGlua0VsZW0pXHJcbiAgICAgIGxpbmtFbGVtLmNsaWNrKClcclxuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChsaW5rRWxlbSlcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgY29uc29sZS5lcnJvcihfdnhldGFibGUudCgndnhlLmVycm9yLm5vdEV4cCcpKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVwbGFjZURvdWJsZVF1b3RhdGlvbiAodmFsOiBzdHJpbmcpIHtcclxuICByZXR1cm4gdmFsLnJlcGxhY2UoL15cIi8sICcnKS5yZXBsYWNlKC9cIiQvLCAnJylcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc3YgKGNvbHVtbnM6IENvbHVtbkNvbmZpZ1tdLCBjb250ZW50OiBzdHJpbmcpIHtcclxuICBjb25zdCBsaXN0ID0gY29udGVudC5zcGxpdCgnXFxuJylcclxuICBjb25zdCBmaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb25zdCByb3dzOiBhbnlbXSA9IFtdXHJcbiAgaWYgKGxpc3QubGVuZ3RoKSB7XHJcbiAgICBjb25zdCByTGlzdCA9IGxpc3Quc2xpY2UoMSlcclxuICAgIGxpc3RbMF0uc3BsaXQoJywnKS5tYXAocmVwbGFjZURvdWJsZVF1b3RhdGlvbilcclxuICAgIHJMaXN0LmZvckVhY2goKHIpID0+IHtcclxuICAgICAgaWYgKHIpIHtcclxuICAgICAgICBjb25zdCBpdGVtOiB7IFtrZXk6IHN0cmluZ106IGFueSB9ID0ge31cclxuICAgICAgICByLnNwbGl0KCcsJykuZm9yRWFjaCgodmFsLCBjb2xJbmRleCkgPT4ge1xyXG4gICAgICAgICAgaWYgKGZpZWxkc1tjb2xJbmRleF0pIHtcclxuICAgICAgICAgICAgaXRlbVtmaWVsZHNbY29sSW5kZXhdXSA9IHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsKVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcm93cy5wdXNoKGl0ZW0pXHJcbiAgICAgIH1cclxuICAgIH0pXHJcbiAgfVxyXG4gIHJldHVybiB7IGZpZWxkcywgcm93cyB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNoZWNrSW1wb3J0RGF0YSAoY29sdW1uczogQ29sdW1uQ29uZmlnW10sIGZpZWxkczogc3RyaW5nW10sIHJvd3M6IGFueVtdKSB7XHJcbiAgY29uc3QgdGFibGVGaWVsZHM6IHN0cmluZ1tdID0gW11cclxuICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbikgPT4ge1xyXG4gICAgY29uc3QgZmllbGQgPSBjb2x1bW4ucHJvcGVydHlcclxuICAgIGlmIChmaWVsZCkge1xyXG4gICAgICB0YWJsZUZpZWxkcy5wdXNoKGZpZWxkKVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgcmV0dXJuIHRhYmxlRmllbGRzLmV2ZXJ5KChmaWVsZCkgPT4gZmllbGRzLmluY2x1ZGVzKGZpZWxkKSlcclxufVxyXG5cclxuZnVuY3Rpb24gaW1wb3J0WExTWCAocGFyYW1zOiBJbnRlcmNlcHRvckltcG9ydFBhcmFtcykge1xyXG4gIGNvbnN0IHsgY29sdW1ucywgb3B0aW9ucywgZmlsZSB9ID0gcGFyYW1zXHJcbiAgY29uc3QgJHRhYmxlOiBhbnkgPSBwYXJhbXMuJHRhYmxlXHJcbiAgY29uc3QgeyBfaW1wb3J0UmVzb2x2ZSB9ID0gJHRhYmxlXHJcbiAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICBmaWxlUmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkKGUudGFyZ2V0LnJlc3VsdCwgeyB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gICAgY29uc3QgY3N2RGF0YTogc3RyaW5nID0gWExTWC51dGlscy5zaGVldF90b19jc3Yod29ya2Jvb2suU2hlZXRzLlNoZWV0MSlcclxuICAgIGNvbnN0IHsgZmllbGRzLCByb3dzIH0gPSBwYXJzZUNzdihjb2x1bW5zLCBjc3ZEYXRhKVxyXG4gICAgY29uc3Qgc3RhdHVzID0gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnMsIGZpZWxkcywgcm93cylcclxuICAgIGlmIChzdGF0dXMpIHtcclxuICAgICAgJHRhYmxlLmNyZWF0ZURhdGEocm93cylcclxuICAgICAgICAudGhlbigoZGF0YTogYW55W10pID0+IHtcclxuICAgICAgICAgIGlmIChvcHRpb25zLm1vZGUgPT09ICdhcHBlbmQnKSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5pbnNlcnRBdChkYXRhLCAtMSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5yZWxvYWREYXRhKGRhdGEpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgICBfdnhldGFibGUubW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IFhFVXRpbHMudGVtcGxhdGUoX3Z4ZXRhYmxlLnQoJ3Z4ZS50YWJsZS5pbXBTdWNjZXNzJyksIFtyb3dzLmxlbmd0aF0pLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgX3Z4ZXRhYmxlLm1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBfdnhldGFibGUudCgndnhlLmVycm9yLmltcEZpZWxkcycpLCBzdGF0dXM6ICdlcnJvcicgfSlcclxuICAgIH1cclxuICAgIGlmIChfaW1wb3J0UmVzb2x2ZSkge1xyXG4gICAgICBfaW1wb3J0UmVzb2x2ZShzdGF0dXMpXHJcbiAgICAgICR0YWJsZS5faW1wb3J0UmVzb2x2ZSA9IG51bGxcclxuICAgIH1cclxuICB9XHJcbiAgZmlsZVJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSlcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlSW1wb3J0RXZlbnQgKHBhcmFtczogSW50ZXJjZXB0b3JJbXBvcnRQYXJhbXMpIHtcclxuICBpZiAocGFyYW1zLm9wdGlvbnMudHlwZSA9PT0gJ3hsc3gnKSB7XHJcbiAgICBpbXBvcnRYTFNYKHBhcmFtcylcclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlRXhwb3J0RXZlbnQgKHBhcmFtczogSW50ZXJjZXB0b3JFeHBvcnRQYXJhbXMpIHtcclxuICBpZiAocGFyYW1zLm9wdGlvbnMudHlwZSA9PT0gJ3hsc3gnKSB7XHJcbiAgICBleHBvcnRYTFNYKHBhcmFtcylcclxuICAgIHJldHVybiBmYWxzZVxyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIOWfuuS6jiB2eGUtdGFibGUg6KGo5qC855qE5aKe5by65o+S5Lu277yM5pSv5oyB5a+85Ye6IHhsc3gg5qC85byPXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYID0ge1xyXG4gIGluc3RhbGwgKHh0YWJsZTogdHlwZW9mIFZYRVRhYmxlKSB7XHJcbiAgICBjb25zdCB7IGludGVyY2VwdG9yIH0gPSB4dGFibGVcclxuICAgIF92eGV0YWJsZSA9IHh0YWJsZVxyXG4gICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgeGxzeDogMSB9KVxyXG4gICAgaW50ZXJjZXB0b3IubWl4aW4oe1xyXG4gICAgICAnZXZlbnQuaW1wb3J0JzogaGFuZGxlSW1wb3J0RXZlbnQsXHJcbiAgICAgICdldmVudC5leHBvcnQnOiBoYW5kbGVFeHBvcnRFdmVudFxyXG4gICAgfSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWClcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYXHJcbiJdfQ==

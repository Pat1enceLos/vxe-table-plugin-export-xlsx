"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _xlsx = _interopRequireDefault(require("xlsx"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function getFooterCellValue($table, opts, rows, column) {
  var cellValue = _xeUtils["default"].toString(rows[$table.$getColumnIndex(column)]);

  return cellValue;
}

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  var rowList = datas;

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
    });
  }

  if (isFooter) {
    var footerData = $table.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = getFooterCellValue($table, options, rows, column);
      });
      footList.push(item);
    });
  }

  var book = _xlsx["default"].utils.book_new();

  var sheet = _xlsx["default"].utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  }); // 转换数据


  _xlsx["default"].utils.book_append_sheet(book, sheet, sheetName);

  var wbout = _xlsx["default"].write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });

  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  downloadFile(blob, options);

  if (message !== false) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(i18n('vxe.error.notExp'));
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').map(replaceDoubleQuotation);
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          if (fields[colIndex]) {
            item[fields[colIndex]] = replaceDoubleQuotation(val);
          }
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var $table = params.$table,
      columns = params.columns,
      options = params.options,
      file = params.file;
  var _importCallback = $table._importCallback,
      _importResolve = $table._importResolve;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = _xlsx["default"].read(e.target.result, {
      type: 'binary'
    });

    var csvData = _xlsx["default"].utils.sheet_to_csv(workbook.Sheets.Sheet1);

    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message !== false) {
        $table.$XModal.message({
          message: i18n('vxe.table.impSuccess'),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      $table.$XModal.message({
        message: i18n('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importResolve) {
      _importResolve(status);

      $table._importResolve = null;
    } else if (_importCallback) {
      // 已废弃
      _importCallback(status);

      $table._importCallback = null;
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */


var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
    VXETablePluginExportXLSX.t = xtable.t;
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;

function i18n(key) {
  if (VXETablePluginExportXLSX.t) {
    return VXETablePluginExportXLSX.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}

var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImdldEZvb3RlckNlbGxWYWx1ZSIsIiR0YWJsZSIsIm9wdHMiLCJyb3dzIiwiY29sdW1uIiwiY2VsbFZhbHVlIiwiWEVVdGlscyIsInRvU3RyaW5nIiwiJGdldENvbHVtbkluZGV4IiwidG9CdWZmZXIiLCJ3Ym91dCIsImJ1ZiIsIkFycmF5QnVmZmVyIiwibGVuZ3RoIiwidmlldyIsIlVpbnQ4QXJyYXkiLCJpbmRleCIsImNoYXJDb2RlQXQiLCJleHBvcnRYTFNYIiwicGFyYW1zIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNoZWV0TmFtZSIsInR5cGUiLCJpc0hlYWRlciIsImlzRm9vdGVyIiwib3JpZ2luYWwiLCJtZXNzYWdlIiwiZm9vdGVyRmlsdGVyTWV0aG9kIiwiY29sSGVhZCIsImZvb3RMaXN0Iiwicm93TGlzdCIsImZvckVhY2giLCJpZCIsInByb3BlcnR5IiwiZ2V0VGl0bGUiLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsIml0ZW0iLCJwdXNoIiwiYm9vayIsIlhMU1giLCJ1dGlscyIsImJvb2tfbmV3Iiwic2hlZXQiLCJqc29uX3RvX3NoZWV0IiwiY29uY2F0Iiwic2tpcEhlYWRlciIsImJvb2tfYXBwZW5kX3NoZWV0Iiwid3JpdGUiLCJib29rVHlwZSIsImJvb2tTU1QiLCJibG9iIiwiQmxvYiIsImRvd25sb2FkRmlsZSIsIiRYTW9kYWwiLCJpMThuIiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJkb3dubG9hZCIsImhyZWYiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJib2R5IiwiYXBwZW5kQ2hpbGQiLCJjbGljayIsInJlbW92ZUNoaWxkIiwiY29uc29sZSIsImVycm9yIiwicmVwbGFjZURvdWJsZVF1b3RhdGlvbiIsInZhbCIsInJlcGxhY2UiLCJwYXJzZUNzdiIsImNvbnRlbnQiLCJsaXN0Iiwic3BsaXQiLCJmaWVsZHMiLCJyTGlzdCIsInNsaWNlIiwibWFwIiwiciIsImNvbEluZGV4IiwiY2hlY2tJbXBvcnREYXRhIiwidGFibGVGaWVsZHMiLCJmaWVsZCIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRDYWxsYmFjayIsIl9pbXBvcnRSZXNvbHZlIiwiZmlsZVJlYWRlciIsIkZpbGVSZWFkZXIiLCJvbmxvYWQiLCJlIiwid29ya2Jvb2siLCJyZWFkIiwicmVzdWx0IiwiY3N2RGF0YSIsInNoZWV0X3RvX2NzdiIsIlNoZWV0cyIsIlNoZWV0MSIsInJlc3QiLCJjcmVhdGVEYXRhIiwidGhlbiIsImRhdGEiLCJtb2RlIiwiaW5zZXJ0QXQiLCJyZWxvYWREYXRhIiwicmVhZEFzQmluYXJ5U3RyaW5nIiwiaGFuZGxlSW1wb3J0RXZlbnQiLCJoYW5kbGVFeHBvcnRFdmVudCIsIlZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWCIsImluc3RhbGwiLCJ4dGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJpbnRlcmNlcHRvciIsIm1peGluIiwidCIsImtleSIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7QUFFQSxTQUFTQSxrQkFBVCxDQUE2QkMsTUFBN0IsRUFBMENDLElBQTFDLEVBQXFEQyxJQUFyRCxFQUFrRUMsTUFBbEUsRUFBNkU7QUFDM0UsTUFBSUMsU0FBUyxHQUFHQyxvQkFBUUMsUUFBUixDQUFpQkosSUFBSSxDQUFDRixNQUFNLENBQUNPLGVBQVAsQ0FBdUJKLE1BQXZCLENBQUQsQ0FBckIsQ0FBaEI7O0FBQ0EsU0FBT0MsU0FBUDtBQUNEOztBQUVELFNBQVNJLFFBQVQsQ0FBbUJDLEtBQW5CLEVBQTZCO0FBQzNCLE1BQUlDLEdBQUcsR0FBRyxJQUFJQyxXQUFKLENBQWdCRixLQUFLLENBQUNHLE1BQXRCLENBQVY7QUFDQSxNQUFJ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QVQsQ0FBNEJyRyxNQUE1QixFQUF1QztBQUNyQyxNQUFJQSxNQUFNLENBQUNDLE9BQVAsQ0FBZUksSUFBZixLQUF3QixNQUE1QixFQUFvQztBQUNsQ04sSUFBQUEsVUFBVSxDQUFDQyxNQUFELENBQVY7QUFDQSxXQUFPLEtBQVA7QUFDRDtBQUNGO0FBRUQ7Ozs7O0FBR08sSUFBTXNHLHdCQUF3QixHQUFRO0FBQzNDQyxFQUFBQSxPQUQyQyxtQkFDbENDLE1BRGtDLEVBQ1g7QUFDOUJDLElBQUFBLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjRixNQUFNLENBQUNHLEtBQXJCLEVBQTRCO0FBQUVDLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQTVCO0FBQ0FKLElBQUFBLE1BQU0sQ0FBQ0ssV0FBUCxDQUFtQkMsS0FBbkIsQ0FBeUI7QUFDdkIsc0JBQWdCVixpQkFETztBQUV2QixzQkFBZ0JDO0FBRk8sS0FBekI7QUFJQUMsSUFBQUEsd0JBQXdCLENBQUNTLENBQXpCLEdBQTZCUCxNQUFNLENBQUNPLENBQXBDO0FBQ0Q7QUFSMEMsQ0FBdEM7OztBQVdQLFNBQVN4RSxJQUFULENBQWV5RSxHQUFmLEVBQTBCO0FBQ3hCLE1BQUlWLHdCQUF3QixDQUFDUyxDQUE3QixFQUFnQztBQUM5QixXQUFPVCx3QkFBd0IsQ0FBQ1MsQ0FBekIsQ0FBMkJDLEdBQTNCLENBQVA7QUFDRDtBQUNGOztBQUVELElBQUksT0FBT3ZFLE1BQVAsS0FBa0IsV0FBbEIsSUFBaUNBLE1BQU0sQ0FBQ3dFLFFBQTVDLEVBQXNEO0FBQ3BEeEUsRUFBQUEsTUFBTSxDQUFDd0UsUUFBUCxDQUFnQkMsR0FBaEIsQ0FBb0JaLHdCQUFwQjtBQUNEOztlQUVjQSx3QiIsImZpbGUiOiJpbmRleC5jb21tb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgWEVVdGlscyBmcm9tICd4ZS11dGlscy9tZXRob2RzL3hlLXV0aWxzJ1xyXG5pbXBvcnQgVlhFVGFibGUgZnJvbSAndnhlLXRhYmxlL2xpYi92eGUtdGFibGUnXHJcbmltcG9ydCBYTFNYIGZyb20gJ3hsc3gnXHJcblxyXG5mdW5jdGlvbiBnZXRGb290ZXJDZWxsVmFsdWUgKCR0YWJsZTogYW55LCBvcHRzOiBhbnksIHJvd3M6IGFueVtdLCBjb2x1bW46IGFueSkge1xyXG4gIHZhciBjZWxsVmFsdWUgPSBYRVV0aWxzLnRvU3RyaW5nKHJvd3NbJHRhYmxlLiRnZXRDb2x1bW5JbmRleChjb2x1bW4pXSlcclxuICByZXR1cm4gY2VsbFZhbHVlXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRvQnVmZmVyICh3Ym91dDogYW55KSB7XHJcbiAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpXHJcbiAgbGV0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpXHJcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCAhPT0gd2JvdXQubGVuZ3RoOyArK2luZGV4KSB2aWV3W2luZGV4XSA9IHdib3V0LmNoYXJDb2RlQXQoaW5kZXgpICYgMHhGRlxyXG4gIHJldHVybiBidWZcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0WExTWCAocGFyYW1zOiBhbnkpIHtcclxuICBjb25zdCB7ICR0YWJsZSwgb3B0aW9ucywgY29sdW1ucywgZGF0YXMgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgc2hlZXROYW1lLCB0eXBlLCBpc0hlYWRlciwgaXNGb290ZXIsIG9yaWdpbmFsLCBtZXNzYWdlLCBmb290ZXJGaWx0ZXJNZXRob2QgfSA9IG9wdGlvbnNcclxuICBjb25zdCBjb2xIZWFkOiBhbnkgPSB7fVxyXG4gIGNvbnN0IGZvb3RMaXN0OiBhbnlbXSA9IFtdXHJcbiAgY29uc3Qgcm93TGlzdCA9IGRhdGFzXHJcbiAgaWYgKGlzSGVhZGVyKSB7XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IFhFVXRpbHMudG9TdHJpbmcob3JpZ2luYWwgPyBjb2x1bW4ucHJvcGVydHkgOiBjb2x1bW4uZ2V0VGl0bGUoKSlcclxuICAgIH0pXHJcbiAgfVxyXG4gIGlmIChpc0Zvb3Rlcikge1xyXG4gICAgY29uc3QgZm9vdGVyRGF0YTogYW55W10gPSAkdGFibGUuZm9vdGVyRGF0YVxyXG4gICAgY29uc3QgZm9vdGVyczogYW55W10gPSBmb290ZXJGaWx0ZXJNZXRob2QgPyBmb290ZXJEYXRhLmZpbHRlcihmb290ZXJGaWx0ZXJNZXRob2QpIDogZm9vdGVyRGF0YVxyXG4gICAgZm9vdGVycy5mb3JFYWNoKChyb3dzOiBhbnlbXSkgPT4ge1xyXG4gICAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgICAgaXRlbVtjb2x1bW4uaWRdID0gZ2V0Rm9vdGVyQ2VsbFZhbHVlKCR0YWJsZSwgb3B0aW9ucywgcm93cywgY29sdW1uKVxyXG4gICAgICB9KVxyXG4gICAgICBmb290TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH1cclxuICBjb25zdCBib29rID0gWExTWC51dGlscy5ib29rX25ldygpXHJcbiAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSlcclxuICAvLyDovazmjaLmlbDmja5cclxuICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpXHJcbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6IHR5cGUsIGJvb2tTU1Q6IGZhbHNlLCB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdG9CdWZmZXIod2JvdXQpXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KVxyXG4gIC8vIOS/neWtmOWvvOWHulxyXG4gIGRvd25sb2FkRmlsZShibG9iLCBvcHRpb25zKVxyXG4gIGlmIChtZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgJHRhYmxlLiRYTW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IGkxOG4oJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZEZpbGUgKGJsb2I6IEJsb2IsIG9wdGlvbnM6IGFueSkge1xyXG4gIGlmICh3aW5kb3cuQmxvYikge1xyXG4gICAgY29uc3QgeyBmaWxlbmFtZSwgdHlwZSB9ID0gb3B0aW9uc1xyXG4gICAgaWYgKG5hdmlnYXRvci5tc1NhdmVCbG9iKSB7XHJcbiAgICAgIG5hdmlnYXRvci5tc1NhdmVCbG9iKGJsb2IsIGAke2ZpbGVuYW1lfS4ke3R5cGV9YClcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHZhciBsaW5rRWxlbSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKVxyXG4gICAgICBsaW5rRWxlbS50YXJnZXQgPSAnX2JsYW5rJ1xyXG4gICAgICBsaW5rRWxlbS5kb3dubG9hZCA9IGAke2ZpbGVuYW1lfS4ke3R5cGV9YFxyXG4gICAgICBsaW5rRWxlbS5ocmVmID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKGxpbmtFbGVtKVxyXG4gICAgICBsaW5rRWxlbS5jbGljaygpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlQ2hpbGQobGlua0VsZW0pXHJcbiAgICB9XHJcbiAgfSBlbHNlIHtcclxuICAgIGNvbnNvbGUuZXJyb3IoaTE4bigndnhlLmVycm9yLm5vdEV4cCcpKVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcmVwbGFjZURvdWJsZVF1b3RhdGlvbiAodmFsOiBzdHJpbmcpIHtcclxuICByZXR1cm4gdmFsLnJlcGxhY2UoL15cIi8sICcnKS5yZXBsYWNlKC9cIiQvLCAnJylcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc3YgKGNvbHVtbnM6IGFueVtdLCBjb250ZW50OiBzdHJpbmcpIHtcclxuICBjb25zdCBsaXN0OiBzdHJpbmdbXSA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpXHJcbiAgY29uc3QgZmllbGRzOiBhbnlbXSA9IFtdXHJcbiAgY29uc3Qgcm93czogYW55W10gPSBbXVxyXG4gIGlmIChsaXN0Lmxlbmd0aCkge1xyXG4gICAgY29uc3Qgckxpc3Q6IHN0cmluZ1tdID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLm1hcChyZXBsYWNlRG91YmxlUXVvdGF0aW9uKVxyXG4gICAgckxpc3QuZm9yRWFjaCgocjogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgICAgICByLnNwbGl0KCcsJykuZm9yRWFjaCgodmFsOiBzdHJpbmcsIGNvbEluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgIGlmIChmaWVsZHNbY29sSW5kZXhdKSB7XHJcbiAgICAgICAgICAgIGl0ZW1bZmllbGRzW2NvbEluZGV4XV0gPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbClcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIHJvd3MucHVzaChpdGVtKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuICByZXR1cm4geyBmaWVsZHMsIHJvd3MgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja0ltcG9ydERhdGEgKGNvbHVtbnM6IGFueVtdLCBmaWVsZHM6IHN0cmluZ1tdLCByb3dzOiBhbnlbXSkge1xyXG4gIGxldCB0YWJsZUZpZWxkczogc3RyaW5nW10gPSBbXVxyXG4gIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgIGxldCBmaWVsZDogc3RyaW5nID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICBpZiAoZmllbGQpIHtcclxuICAgICAgdGFibGVGaWVsZHMucHVzaChmaWVsZClcclxuICAgIH1cclxuICB9KVxyXG4gIHJldHVybiB0YWJsZUZpZWxkcy5ldmVyeSgoZmllbGQ6IHN0cmluZykgPT4gZmllbGRzLmluY2x1ZGVzKGZpZWxkKSlcclxufVxyXG5cclxuZnVuY3Rpb24gaW1wb3J0WExTWCAocGFyYW1zOiBhbnkpIHtcclxuICBjb25zdCB7ICR0YWJsZSwgY29sdW1ucywgb3B0aW9ucywgZmlsZSB9ID0gcGFyYW1zXHJcbiAgY29uc3QgeyBfaW1wb3J0Q2FsbGJhY2ssIF9pbXBvcnRSZXNvbHZlIH0gPSAkdGFibGVcclxuICBjb25zdCBmaWxlUmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKVxyXG4gIGZpbGVSZWFkZXIub25sb2FkID0gKGU6IGFueSkgPT4ge1xyXG4gICAgY29uc3Qgd29ya2Jvb2sgPSBYTFNYLnJlYWQoZS50YXJnZXQucmVzdWx0LCB7IHR5cGU6ICdiaW5hcnknIH0pXHJcbiAgICBjb25zdCBjc3ZEYXRhOiBzdHJpbmcgPSBYTFNYLnV0aWxzLnNoZWV0X3RvX2Nzdih3b3JrYm9vay5TaGVldHMuU2hlZXQxKVxyXG4gICAgY29uc3QgcmVzdDogYW55ID0gcGFyc2VDc3YoY29sdW1ucywgY3N2RGF0YSlcclxuICAgIGNvbnN0IHsgZmllbGRzLCByb3dzIH0gPSByZXN0XHJcbiAgICBjb25zdCBzdGF0dXMgPSBjaGVja0ltcG9ydERhdGEoY29sdW1ucywgZmllbGRzLCByb3dzKVxyXG4gICAgaWYgKHN0YXR1cykge1xyXG4gICAgICAkdGFibGUuY3JlYXRlRGF0YShyb3dzKVxyXG4gICAgICAgIC50aGVuKChkYXRhOiBhbnlbXSkgPT4ge1xyXG4gICAgICAgICAgaWYgKG9wdGlvbnMubW9kZSA9PT0gJ2FwcGVuZCcpIHtcclxuICAgICAgICAgICAgJHRhYmxlLmluc2VydEF0KGRhdGEsIC0xKVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgJHRhYmxlLnJlbG9hZERhdGEoZGF0YSlcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICBpZiAob3B0aW9ucy5tZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUudGFibGUuaW1wU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgJHRhYmxlLiRYTW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IGkxOG4oJ3Z4ZS5lcnJvci5pbXBGaWVsZHMnKSwgc3RhdHVzOiAnZXJyb3InIH0pXHJcbiAgICB9XHJcbiAgICBpZiAoX2ltcG9ydFJlc29sdmUpIHtcclxuICAgICAgX2ltcG9ydFJlc29sdmUoc3RhdHVzKVxyXG4gICAgICAkdGFibGUuX2ltcG9ydFJlc29sdmUgPSBudWxsXHJcbiAgICB9IGVsc2UgaWYgKF9pbXBvcnRDYWxsYmFjaykge1xyXG4gICAgICAvLyDlt7Llup/lvINcclxuICAgICAgX2ltcG9ydENhbGxiYWNrKHN0YXR1cylcclxuICAgICAgJHRhYmxlLl9pbXBvcnRDYWxsYmFjayA9IG51bGxcclxuICAgIH1cclxuICB9XHJcbiAgZmlsZVJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSlcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlSW1wb3J0RXZlbnQgKHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50IChwYXJhbXM6IGFueSkge1xyXG4gIGlmIChwYXJhbXMub3B0aW9ucy50eXBlID09PSAneGxzeCcpIHtcclxuICAgIGV4cG9ydFhMU1gocGFyYW1zKVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICog5Z+65LqOIHZ4ZS10YWJsZSDooajmoLznmoTlop7lvLrmj5Lku7bvvIzmlK/mjIHlr7zlh7ogeGxzeCDmoLzlvI9cclxuICovXHJcbmV4cG9ydCBjb25zdCBWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1g6IGFueSA9IHtcclxuICBpbnN0YWxsICh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSkge1xyXG4gICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgeGxzeDogMSB9KVxyXG4gICAgeHRhYmxlLmludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmltcG9ydCc6IGhhbmRsZUltcG9ydEV2ZW50LFxyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgICBWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gudCA9IHh0YWJsZS50XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBpMThuIChrZXk6IHN0cmluZykge1xyXG4gIGlmIChWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gudCkge1xyXG4gICAgcmV0dXJuIFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWC50KGtleSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWClcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYXHJcbiJdfQ==

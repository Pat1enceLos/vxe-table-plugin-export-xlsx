"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExport = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var XLSX = _interopRequireWildcard(require("xlsx"));

function _getRequireWildcardCache() { if (typeof WeakMap !== "function") return null; var cache = new WeakMap(); _getRequireWildcardCache = function _getRequireWildcardCache() { return cache; }; return cache; }

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } var cache = _getRequireWildcardCache(); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; if (obj != null) { var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } } newObj["default"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      original = options.original,
      message = options.message;
  var colHead = {};

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = original ? column.property : column.getTitle();
    });
  }

  var rowList = datas.map(function (row) {
    var item = {};
    columns.forEach(function (column) {
      item[column.id] = original ? _xeUtils["default"].get(row, column.property) : row[column.id];
    });
    return item;
  });
  var book = XLSX.utils.book_new();
  var sheet = XLSX.utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList), {
    skipHeader: true
  }); // 转换数据

  XLSX.utils.book_append_sheet(book, sheet, sheetName);
  var wbout = XLSX.write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });
  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  download(blob, options);

  if (message) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function download(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, filename);
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(i18n('vxe.error.notExp'));
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').forEach(function (val) {
      var field = replaceDoubleQuotation(val);

      if (field) {
        fields.push(field);
      }
    });
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          item[fields[colIndex]] = replaceDoubleQuotation(val);
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var $table = params.$table,
      columns = params.columns,
      options = params.options,
      file = params.file;
  var _importCallback = $table._importCallback;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = XLSX.read(e.target.result, {
      type: 'binary'
    });
    var csvData = XLSX.utils.sheet_to_csv(workbook.Sheets.Sheet1);
    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message) {
        $table.$XModal.message({
          message: i18n('vxe.table.impSuccess'),
          status: 'success'
        });
      }
    } else if (options.message) {
      $table.$XModal.message({
        message: i18n('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importCallback) {
      _importCallback(status);
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  switch (params.options.type) {
    case 'xlsx':
      importXLSX(params);
      return false;
  }
}

function handleExportEvent(params) {
  switch (params.options.type) {
    case 'xlsx':
      exportXLSX(params);
      return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 等格式
 */


var VXETablePluginExport = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
    VXETablePluginExport.t = xtable.t;
  }
};
exports.VXETablePluginExport = VXETablePluginExport;

function i18n(key) {
  if (VXETablePluginExport.t) {
    return VXETablePluginExport.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExport);
}

var _default = VXETablePluginExport;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbInRvQnVmZmVyIiwid2JvdXQiLCJidWYiLCJBcnJheUJ1ZmZlciIsImxlbmd0aCIsInZpZXciLCJVaW50OEFycmF5IiwiaW5kZXgiLCJjaGFyQ29kZUF0IiwiZXhwb3J0WExTWCIsInBhcmFtcyIsIiR0YWJsZSIsIm9wdGlvbnMiLCJjb2x1bW5zIiwiZGF0YXMiLCJzaGVldE5hbWUiLCJ0eXBlIiwiaXNIZWFkZXIiLCJvcmlnaW5hbCIsIm1lc3NhZ2UiLCJjb2xIZWFkIiwiZm9yRWFjaCIsImNvbHVtbiIsImlkIiwicHJvcGVydHkiLCJnZXRUaXRsZSIsInJvd0xpc3QiLCJtYXAiLCJyb3ciLCJpdGVtIiwiWEVVdGlscyIsImdldCIsImJvb2siLCJYTFNYIiwidXRpbHMiLCJib29rX25ldyIsInNoZWV0IiwianNvbl90b19zaGVldCIsImNvbmNhdCIsInNraXBIZWFkZXIiLCJib29rX2FwcGVuZF9zaGVldCIsIndyaXRlIiwiYm9va1R5cGUiLCJib29rU1NUIiwiYmxvYiIsIkJsb2IiLCJkb3dubG9hZCIsIiRYTW9kYWwiLCJpMThuIiwic3RhdHVzIiwid2luZG93IiwiZmlsZW5hbWUiLCJuYXZpZ2F0b3IiLCJtc1NhdmVCbG9iIiwibGlua0VsZW0iLCJkb2N1bWVudCIsImNyZWF0ZUVsZW1lbnQiLCJ0YXJnZXQiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsImNvbnNvbGUiLCJlcnJvciIsInJlcGxhY2VEb3VibGVRdW90YXRpb24iLCJ2YWwiLCJyZXBsYWNlIiwicGFyc2VDc3YiLCJjb250ZW50IiwibGlzdCIsInNwbGl0IiwiZmllbGRzIiwicm93cyIsInJMaXN0Iiwic2xpY2UiLCJmaWVsZCIsInB1c2giLCJyIiwiY29sSW5kZXgiLCJjaGVja0ltcG9ydERhdGEiLCJ0YWJsZUZpZWxkcyIsImV2ZXJ5IiwiaW5jbHVkZXMiLCJpbXBvcnRYTFNYIiwiZmlsZSIsIl9pbXBvcnRDYWxsYmFjayIsImZpbGVSZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiZSIsIndvcmtib29rIiwicmVhZCIsInJlc3VsdCIsImNzdkRhdGEiLCJzaGVldF90b19jc3YiLCJTaGVldHMiLCJTaGVldDEiLCJyZXN0IiwiY3JlYXRlRGF0YSIsInRoZW4iLCJkYXRhIiwibW9kZSIsImluc2VydEF0IiwicmVsb2FkRGF0YSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydCIsImluc3RhbGwiLCJ4dGFibGUiLCJPYmplY3QiLCJhc3NpZ24iLCJ0eXBlcyIsInhsc3giLCJpbnRlcmNlcHRvciIsIm1peGluIiwidCIsImtleSIsIlZYRVRhYmxlIiwidXNlIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7O0FBRUE7Ozs7Ozs7O0FBRUEsU0FBU0EsUUFBVCxDQUFrQkMsS0FBbEIsRUFBNEI7QUFDMUIsTUFBSUMsR0FBRyxHQUFHLElBQUlDLFdBQUosQ0FBZ0JGLEtBQUssQ0FBQ0csTUFBdEIsQ0FBVjtBQUNBLE1BQUlDLElBQUksR0FBRyxJQUFJQyxVQUFKLENBQWVKLEdBQWYsQ0FBWDs7QUFDQSxPQUFLLElBQUlLLEtBQUssR0FBRyxDQUFqQixFQUFvQkEsS0FBSyxLQUFLTixLQUFLLENBQUNHLE1BQXBDLEVBQTRDLEVBQUVHLEtBQTlDO0FBQXFERixJQUFBQSxJQUFJLENBQUNFLEtBQUQsQ0FBSixHQUFjTixLQUFLLENBQUNPLFVBQU4sQ0FBaUJELEtBQWpCLElBQTBCLElBQXhDO0FBQXJEOztBQUNBLFNBQU9MLEdBQVA7QUFDRDs7QUFFRCxTQUFTTyxVQUFULENBQW9CQyxNQUFwQixFQUErQjtBQUFBLE1BQ3JCQyxNQURxQixHQUNlRCxNQURmLENBQ3JCQyxNQURxQjtBQUFBLE1BQ2JDLE9BRGEsR0FDZUYsTUFEZixDQUNiRSxPQURhO0FBQUEsTUFDSkMsT0FESSxHQUNlSCxNQURmLENBQ0pHLE9BREk7QUFBQSxNQUNLQyxLQURMLEdBQ2VKLE1BRGYsQ0FDS0ksS0FETDtBQUFBLE1BRXJCQyxTQUZxQixHQUU0QkgsT0FGNUIsQ0FFckJHLFNBRnFCO0FBQUEsTUFFVkMsSUFGVSxHQUU0QkosT0FGNUIsQ0FFVkksSUFGVTtBQUFBLE1BRUpDLFFBRkksR0FFNEJMLE9BRjVCLENBRUpLLFFBRkk7QUFBQSxNQUVNQyxRQUZOLEdBRTRCTixPQUY1QixDQUVNTSxRQUZOO0FBQUEsTUFFZ0JDLE9BRmhCLEdBRTRCUCxPQUY1QixDQUVnQk8sT0FGaEI7QUFHN0IsTUFBTUMsT0FBTyxHQUFRLEVBQXJCOztBQUNBLE1BQUlILFFBQUosRUFBYztBQUNaSixJQUFBQSxPQUFPLENBQUNRLE9BQVIsQ0FBZ0IsVUFBQ0MsTUFBRCxFQUFnQjtBQUM5QkYsTUFBQUEsT0FBTyxDQUFDRSxNQUFNLENBQUNDLEVBQVIsQ0FBUCxHQUFxQkwsUUFBUSxHQUFHSSxNQUFNLENBQUNFLFFBQVYsR0FBcUJGLE1BQU0sQ0FBQ0csUUFBUCxFQUFsRDtBQUNELEtBRkQ7QUFHRDs7QUFDRCxNQUFNQyxPQUFPLEdBQUdaLEtBQUssQ0FBQ2EsR0FBTixDQUFVLFVBQUNDLEdBQUQsRUFBYTtBQUNyQyxRQUFNQyxJQUFJLEdBQVEsRUFBbEI7QUFDQWhCLElBQUFBLE9BQU8sQ0FBQ1EsT0FBUixDQUFnQixVQUFDQyxNQUFELEVBQWdCO0FBQzlCTyxNQUFBQSxJQUFJLENBQUNQLE1BQU0sQ0FBQ0MsRUFBUixDQUFKLEdBQWtCTCxRQUFRLEdBQUdZLG9CQUFRQyxHQUFSLENBQVlILEdBQVosRUFBaUJOLE1BQU0sQ0FBQ0UsUUFBeEIsQ0FBSCxHQUF1Q0ksR0FBRyxDQUFDTixNQUFNLENBQUNDLEVBQVIsQ0FBcEU7QUFDRCxLQUZEO0FBR0EsV0FBT00sSUFBUDtBQUNELEdBTmUsQ0FBaEI7QUFPQSxNQUFNRyxJQUFJLEdBQUdDLElBQUksQ0FBQ0MsS0FBTCxDQUFXQyxRQUFYLEVBQWI7QUFDQSxNQUFNQyxLQUFLLEdBQUdILElBQUksQ0FBQ0MsS0FBTCxDQUFXRyxhQUFYLENBQXlCLENBQUNwQixRQUFRLEdBQUcsQ0FBQ0csT0FBRCxDQUFILEdBQWUsRUFBeEIsRUFBNEJrQixNQUE1QixDQUFtQ1osT0FBbkMsQ0FBekIsRUFBc0U7QUFBRWEsSUFBQUEsVUFBVSxFQUFFO0FBQWQsR0FBdEUsQ0FBZCxDQWpCNkIsQ0FrQjdCOztBQUNBTixFQUFBQSxJQUFJLENBQUNDLEtBQUwsQ0FBV00saUJBQVgsQ0FBNkJSLElBQTdCLEVBQW1DSSxLQUFuQyxFQUEwQ3JCLFNBQTFDO0FBQ0EsTUFBTWQsS0FBSyxHQUFHZ0MsSUFBSSxDQUFDUSxLQUFMLENBQVdULElBQVgsRUFBaUI7QUFBRVUsSUFBQUEsUUFBUSxFQUFFMUIsSUFBWjtBQUFrQjJCLElBQUFBLE9BQU8sRUFBRSxLQUEzQjtBQUFrQzNCLElBQUFBLElBQUksRUFBRTtBQUF4QyxHQUFqQixDQUFkO0FBQ0EsTUFBTTRCLElBQUksR0FBRyxJQUFJQyxJQUFKLENBQVMsQ0FBQzdDLFFBQVEsQ0FBQ0MsS0FBRCxDQUFULENBQVQsRUFBNEI7QUFBRWUsSUFBQUEsSUFBSSxFQUFFO0FBQVIsR0FBNUIsQ0FBYixDQXJCNkIsQ0FzQjdCOztBQUNBOEIsRUFBQUEsUUFBUSxDQUFDRixJQUFELEVBQU9oQyxPQUFQLENBQVI7O0FBQ0EsTUFBSU8sT0FBSixFQUFhO0FBQ1hSLElBQUFBLE1BQU0sQ0FBQ29DLE9BQVAsQ0FBZTVCLE9BQWYsQ0FBdUI7QUFBRUEsTUFBQUEsT0FBTyxFQUFFNkIsSUFBSSxDQUFDLHNCQUFELENBQWY7QUFBeUNDLE1BQUFBLE1BQU0sRUFBRTtBQUFqRCxLQUF2QjtBQUNEO0FBQ0Y7O0FBRUQsU0FBU0gsUUFBVCxDQUFrQkYsSUFBbEIsRUFBOEJoQyxPQUE5QixFQUEwQztBQUN4QyxNQUFJc0MsTUFBTSxDQUFDTCxJQUFYLEVBQWlCO0FBQUEsUUFDUE0sUUFETyxHQUNZdkMsT0FEWixDQUNQdUMsUUFETztBQUFBLFFBQ0duQyxJQURILEdBQ1lKLE9BRFosQ0FDR0ksSUFESDs7QUFFZixRQUFJb0MsU0FBUyxDQUFDQyxVQUFkLEVBQTBCO0FBQ3hCRCxNQUFBQSxTQUFTLENBQUNDLFVBQVYsQ0FBcUJULElBQXJCLEVBQTJCTyxRQUEzQjtBQUNELEtBRkQsTUFFTztBQUNMLFVBQUlHLFFBQVEsR0FBR0MsUUFBUSxDQUFDQyxhQUFULENBQXVCLEdBQXZCLENBQWY7QUFDQUYsTUFBQUEsUUFBUSxDQUFDRyxNQUFULEdBQWtCLFFBQWxCO0FBQ0FILE1BQUFBLFFBQVEsQ0FBQ1IsUUFBVCxhQUF1QkssUUFBdkIsY0FBbUNuQyxJQUFuQztBQUNBc0MsTUFBQUEsUUFBUSxDQUFDSSxJQUFULEdBQWdCQyxHQUFHLENBQUNDLGVBQUosQ0FBb0JoQixJQUFwQixDQUFoQjtBQUNBVyxNQUFBQSxRQUFRLENBQUNNLElBQVQsQ0FBY0MsV0FBZCxDQUEwQlIsUUFBMUI7QUFDQUEsTUFBQUEsUUFBUSxDQUFDUyxLQUFUO0FBQ0FSLE1BQUFBLFFBQVEsQ0FBQ00sSUFBVCxDQUFjRyxXQUFkLENBQTBCVixRQUExQjtBQUNEO0FBQ0YsR0FiRCxNQWFPO0FBQ0xXLElBQUFBLE9BQU8sQ0FBQ0MsS0FBUixDQUFjbEIsSUFBSSxDQUFDLGtCQUFELENBQWxCO0FBQ0Q7QUFDRjs7QUFFRCxTQUFTbUIsc0JBQVQsQ0FBZ0NDLEdBQWhDLEVBQTJDO0FBQ3pDLFNBQU9BLEdBQUcsQ0FBQ0MsT0FBSixDQUFZLElBQVosRUFBa0IsRUFBbEIsRUFBc0JBLE9BQXRCLENBQThCLElBQTlCLEVBQW9DLEVBQXBDLENBQVA7QUFDRDs7QUFFRCxTQUFTQyxRQUFULENBQWtCekQsT0FBbEIsRUFBa0MwRCxPQUFsQyxFQUFpRDtBQUMvQyxNQUFNQyxJQUFJLEdBQWFELE9BQU8sQ0FBQ0UsS0FBUixDQUFjLElBQWQsQ0FBdkI7QUFDQSxNQUFNQyxNQUFNLEdBQVUsRUFBdEI7QUFDQSxNQUFNQyxJQUFJLEdBQVUsRUFBcEI7O0FBQ0EsTUFBSUgsSUFBSSxDQUFDcEUsTUFBVCxFQUFpQjtBQUNmLFFBQU13RSxLQUFLLEdBQWFKLElBQUksQ0FBQ0ssS0FBTCxDQUFXLENBQVgsQ0FBeEI7QUFDQUwsSUFBQUEsSUFBSSxDQUFDLENBQUQsQ0FBSixDQUFRQyxLQUFSLENBQWMsR0FBZCxFQUFtQnBELE9BQW5CLENBQTJCLFVBQUMrQyxHQUFELEVBQWdCO0FBQ3pDLFVBQU1VLEtBQUssR0FBV1gsc0JBQXNCLENBQUNDLEdBQUQsQ0FBNUM7O0FBQ0EsVUFBSVUsS0FBSixFQUFXO0FBQ1RKLFFBQUFBLE1BQU0sQ0FBQ0ssSUFBUCxDQUFZRCxLQUFaO0FBQ0Q7QUFDRixLQUxEO0FBTUFGLElBQUFBLEtBQUssQ0FBQ3ZELE9BQU4sQ0FBYyxVQUFDMkQsQ0FBRCxFQUFjO0FBQzFCLFVBQUlBLENBQUosRUFBTztBQUNMLFlBQU1uRCxJQUFJLEdBQVEsRUFBbEI7QUFDQW1ELFFBQUFBLENBQUMsQ0FBQ1AsS0FBRixDQUFRLEdBQVIsRUFBYXBELE9BQWIsQ0FBcUIsVUFBQytDLEdBQUQsRUFBY2EsUUFBZCxFQUFrQztBQUNyRHBELFVBQUFBLElBQUksQ0FBQzZDLE1BQU0sQ0FBQ08sUUFBRCxDQUFQLENBQUosR0FBeUJkLHNCQUFzQixDQUFDQyxHQUFELENBQS9DO0FBQ0QsU0FGRDtBQUdBTyxRQUFBQSxJQUFJLENBQUNJLElBQUwsQ0FBVWxELElBQVY7QUFDRDtBQUNGLEtBUkQ7QUFTRDs7QUFDRCxTQUFPO0FBQUU2QyxJQUFBQSxNQUFNLEVBQU5BLE1BQUY7QUFBVUMsSUFBQUEsSUFBSSxFQUFKQTtBQUFWLEdBQVA7QUFDRDs7QUFFRCxTQUFTTyxlQUFULENBQXlCckUsT0FBekIsRUFBeUM2RCxNQUF6QyxFQUEyREMsSUFBM0QsRUFBc0U7QUFDcEUsTUFBSVEsV0FBVyxHQUFhLEVBQTVCO0FBQ0F0RSxFQUFBQSxPQUFPLENBQUNRLE9BQVIsQ0FBZ0IsVUFBQ0MsTUFBRCxFQUFnQjtBQUM5QixRQUFJd0QsS0FBSyxHQUFXeEQsTUFBTSxDQUFDRSxRQUEzQjs7QUFDQSxRQUFJc0QsS0FBSixFQUFXO0FBQ1RLLE1BQUFBLFdBQVcsQ0FBQ0osSUFBWixDQUFpQkQsS0FBakI7QUFDRDtBQUNGLEdBTEQ7QUFNQSxTQUFPSyxXQUFXLENBQUNDLEtBQVosQ0FBa0IsVUFBQ04sS0FBRDtBQUFBLFdBQW1CSixNQUFNLENBQUNXLFFBQVAsQ0FBZ0JQLEtBQWhCLENBQW5CO0FBQUEsR0FBbEIsQ0FBUDtBQUNEOztBQUVELFNBQVNRLFVBQVQsQ0FBb0I1RSxNQUFwQixFQUErQjtBQUFBLE1BQ3JCQyxNQURxQixHQUNjRCxNQURkLENBQ3JCQyxNQURxQjtBQUFBLE1BQ2JFLE9BRGEsR0FDY0gsTUFEZCxDQUNiRyxPQURhO0FBQUEsTUFDSkQsT0FESSxHQUNjRixNQURkLENBQ0pFLE9BREk7QUFBQSxNQUNLMkUsSUFETCxHQUNjN0UsTUFEZCxDQUNLNkUsSUFETDtBQUFBLE1BRXJCQyxlQUZxQixHQUVEN0UsTUFGQyxDQUVyQjZFLGVBRnFCO0FBRzdCLE1BQU1DLFVBQVUsR0FBRyxJQUFJQyxVQUFKLEVBQW5COztBQUNBRCxFQUFBQSxVQUFVLENBQUNFLE1BQVgsR0FBb0IsVUFBQ0MsQ0FBRCxFQUFXO0FBQzdCLFFBQU1DLFFBQVEsR0FBRzVELElBQUksQ0FBQzZELElBQUwsQ0FBVUYsQ0FBQyxDQUFDbkMsTUFBRixDQUFTc0MsTUFBbkIsRUFBMkI7QUFBRS9FLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQTNCLENBQWpCO0FBQ0EsUUFBTWdGLE9BQU8sR0FBVy9ELElBQUksQ0FBQ0MsS0FBTCxDQUFXK0QsWUFBWCxDQUF3QkosUUFBUSxDQUFDSyxNQUFULENBQWdCQyxNQUF4QyxDQUF4QjtBQUNBLFFBQU1DLElBQUksR0FBUTlCLFFBQVEsQ0FBQ3pELE9BQUQsRUFBVW1GLE9BQVYsQ0FBMUI7QUFINkIsUUFJckJ0QixNQUpxQixHQUlKMEIsSUFKSSxDQUlyQjFCLE1BSnFCO0FBQUEsUUFJYkMsSUFKYSxHQUlKeUIsSUFKSSxDQUliekIsSUFKYTtBQUs3QixRQUFNMUIsTUFBTSxHQUFHaUMsZUFBZSxDQUFDckUsT0FBRCxFQUFVNkQsTUFBVixFQUFrQkMsSUFBbEIsQ0FBOUI7O0FBQ0EsUUFBSTFCLE1BQUosRUFBWTtBQUNWdEMsTUFBQUEsTUFBTSxDQUFDMEYsVUFBUCxDQUFrQjFCLElBQWxCLEVBQ0cyQixJQURILENBQ1EsVUFBQ0MsSUFBRCxFQUFnQjtBQUNwQixZQUFJM0YsT0FBTyxDQUFDNEYsSUFBUixLQUFpQixRQUFyQixFQUErQjtBQUM3QjdGLFVBQUFBLE1BQU0sQ0FBQzhGLFFBQVAsQ0FBZ0JGLElBQWhCLEVBQXNCLENBQUMsQ0FBdkI7QUFDRCxTQUZELE1BRU87QUFDTDVGLFVBQUFBLE1BQU0sQ0FBQytGLFVBQVAsQ0FBa0JILElBQWxCO0FBQ0Q7QUFDRixPQVBIOztBQVFBLFVBQUkzRixPQUFPLENBQUNPLE9BQVosRUFBcUI7QUFDbkJSLFFBQUFBLE1BQU0sQ0FBQ29DLE9BQVAsQ0FBZTVCLE9BQWYsQ0FBdUI7QUFBRUEsVUFBQUEsT0FBTyxFQUFFNkIsSUFBSSxDQUFDLHNCQUFELENBQWY7QUFBeUNDLFVBQUFBLE1BQU0sRUFBRTtBQUFqRCxTQUF2QjtBQUNEO0FBQ0YsS0FaRCxNQVlPLElBQUlyQyxPQUFPLENBQUNPLE9BQVosRUFBcUI7QUFDMUJSLE1BQUFBLE1BQU0sQ0FBQ29DLE9BQVAsQ0FBZTVCLE9BQWYsQ0FBdUI7QUFBRUEsUUFBQUEsT0FBTyxFQUFFNkIsSUFBSSxDQUFDLHFCQUFELENBQWY7QUFBd0NDLFFBQUFBLE1BQU0sRUFBRTtBQUFoRCxPQUF2QjtBQUNEOztBQUNELFFBQUl1QyxlQUFKLEVBQXFCO0FBQ25CQSxNQUFBQSxlQUFlLENBQUN2QyxNQUFELENBQWY7QUFDRDtBQUNGLEdBeEJEOztBQXlCQXdDLEVBQUFBLFVBQVUsQ0FBQ2tCLGtCQUFYLENBQThCcEIsSUFBOUI7QUFDRDs7QUFFRCxTQUFTcUIsaUJBQVQsQ0FBMkJsRyxNQUEzQixFQUFzQztBQUNwQyxVQUFRQSxNQUFNLENBQUNFLE9BQVAsQ0FBZUksSUFBdkI7QUFDRSxTQUFLLE1BQUw7QUFDRXNFLE1BQUFBLFVBQVUsQ0FBQzVFLE1BQUQsQ0FBVjtBQUNBLGFBQU8sS0FBUDtBQUhKO0FBS0Q7O0FBRUQsU0FBU21HLGlCQUFULENBQTJCbkcsTUFBM0IsRUFBc0M7QUFDcEMsVUFBUUEsTUFBTSxDQUFDRSxPQUFQLENBQWVJLElBQXZCO0FBQ0UsU0FBSyxNQUFMO0FBQ0VQLE1BQUFBLFVBQVUsQ0FBQ0MsTUFBRCxDQUFWO0FBQ0EsYUFBTyxLQUFQO0FBSEo7QUFLRDtBQUVEOzs7OztBQUdPLElBQU1vRyxvQkFBb0IsR0FBUTtBQUN2Q0MsRUFBQUEsT0FEdUMsbUJBQy9CQyxNQUQrQixFQUNSO0FBQzdCQyxJQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY0YsTUFBTSxDQUFDRyxLQUFyQixFQUE0QjtBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUE1QjtBQUNBSixJQUFBQSxNQUFNLENBQUNLLFdBQVAsQ0FBbUJDLEtBQW5CLENBQXlCO0FBQ3ZCLHNCQUFnQlYsaUJBRE87QUFFdkIsc0JBQWdCQztBQUZPLEtBQXpCO0FBSUFDLElBQUFBLG9CQUFvQixDQUFDUyxDQUFyQixHQUF5QlAsTUFBTSxDQUFDTyxDQUFoQztBQUNEO0FBUnNDLENBQWxDOzs7QUFXUCxTQUFTdkUsSUFBVCxDQUFjd0UsR0FBZCxFQUF5QjtBQUN2QixNQUFJVixvQkFBb0IsQ0FBQ1MsQ0FBekIsRUFBNEI7QUFDMUIsV0FBT1Qsb0JBQW9CLENBQUNTLENBQXJCLENBQXVCQyxHQUF2QixDQUFQO0FBQ0Q7QUFDRjs7QUFFRCxJQUFJLE9BQU90RSxNQUFQLEtBQWtCLFdBQWxCLElBQWlDQSxNQUFNLENBQUN1RSxRQUE1QyxFQUFzRDtBQUNwRHZFLEVBQUFBLE1BQU0sQ0FBQ3VFLFFBQVAsQ0FBZ0JDLEdBQWhCLENBQW9CWixvQkFBcEI7QUFDRDs7ZUFFY0Esb0IiLCJmaWxlIjoiaW5kZXguY29tbW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFhFVXRpbHMgZnJvbSAneGUtdXRpbHMvbWV0aG9kcy94ZS11dGlscydcclxuaW1wb3J0IFZYRVRhYmxlIGZyb20gJ3Z4ZS10YWJsZS9saWIvdnhlLXRhYmxlJ1xyXG5pbXBvcnQgKiBhcyBYTFNYIGZyb20gJ3hsc3gnXHJcblxyXG5mdW5jdGlvbiB0b0J1ZmZlcih3Ym91dDogYW55KSB7XHJcbiAgbGV0IGJ1ZiA9IG5ldyBBcnJheUJ1ZmZlcih3Ym91dC5sZW5ndGgpXHJcbiAgbGV0IHZpZXcgPSBuZXcgVWludDhBcnJheShidWYpXHJcbiAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCAhPT0gd2JvdXQubGVuZ3RoOyArK2luZGV4KSB2aWV3W2luZGV4XSA9IHdib3V0LmNoYXJDb2RlQXQoaW5kZXgpICYgMHhGRlxyXG4gIHJldHVybiBidWZcclxufVxyXG5cclxuZnVuY3Rpb24gZXhwb3J0WExTWChwYXJhbXM6IGFueSkge1xyXG4gIGNvbnN0IHsgJHRhYmxlLCBvcHRpb25zLCBjb2x1bW5zLCBkYXRhcyB9ID0gcGFyYW1zXHJcbiAgY29uc3QgeyBzaGVldE5hbWUsIHR5cGUsIGlzSGVhZGVyLCBvcmlnaW5hbCwgbWVzc2FnZSB9ID0gb3B0aW9uc1xyXG4gIGNvbnN0IGNvbEhlYWQ6IGFueSA9IHt9XHJcbiAgaWYgKGlzSGVhZGVyKSB7XHJcbiAgICBjb2x1bW5zLmZvckVhY2goKGNvbHVtbjogYW55KSA9PiB7XHJcbiAgICAgIGNvbEhlYWRbY29sdW1uLmlkXSA9IG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKClcclxuICAgIH0pXHJcbiAgfVxyXG4gIGNvbnN0IHJvd0xpc3QgPSBkYXRhcy5tYXAoKHJvdzogYW55KSA9PiB7XHJcbiAgICBjb25zdCBpdGVtOiBhbnkgPSB7fVxyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICBpdGVtW2NvbHVtbi5pZF0gPSBvcmlnaW5hbCA/IFhFVXRpbHMuZ2V0KHJvdywgY29sdW1uLnByb3BlcnR5KSA6IHJvd1tjb2x1bW4uaWRdXHJcbiAgICB9KVxyXG4gICAgcmV0dXJuIGl0ZW1cclxuICB9KVxyXG4gIGNvbnN0IGJvb2sgPSBYTFNYLnV0aWxzLmJvb2tfbmV3KClcclxuICBjb25zdCBzaGVldCA9IFhMU1gudXRpbHMuanNvbl90b19zaGVldCgoaXNIZWFkZXIgPyBbY29sSGVhZF0gOiBbXSkuY29uY2F0KHJvd0xpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSlcclxuICAvLyDovazmjaLmlbDmja5cclxuICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpXHJcbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6IHR5cGUsIGJvb2tTU1Q6IGZhbHNlLCB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdG9CdWZmZXIod2JvdXQpXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KVxyXG4gIC8vIOS/neWtmOWvvOWHulxyXG4gIGRvd25sb2FkKGJsb2IsIG9wdGlvbnMpXHJcbiAgaWYgKG1lc3NhZ2UpIHtcclxuICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUudGFibGUuZXhwU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gZG93bmxvYWQoYmxvYjogQmxvYiwgb3B0aW9uczogYW55KSB7XHJcbiAgaWYgKHdpbmRvdy5CbG9iKSB7XHJcbiAgICBjb25zdCB7IGZpbGVuYW1lLCB0eXBlIH0gPSBvcHRpb25zXHJcbiAgICBpZiAobmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHtcclxuICAgICAgbmF2aWdhdG9yLm1zU2F2ZUJsb2IoYmxvYiwgZmlsZW5hbWUpXHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICB2YXIgbGlua0VsZW0gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJylcclxuICAgICAgbGlua0VsZW0udGFyZ2V0ID0gJ19ibGFuaydcclxuICAgICAgbGlua0VsZW0uZG93bmxvYWQgPSBgJHtmaWxlbmFtZX0uJHt0eXBlfWBcclxuICAgICAgbGlua0VsZW0uaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYilcclxuICAgICAgZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChsaW5rRWxlbSlcclxuICAgICAgbGlua0VsZW0uY2xpY2soKVxyXG4gICAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUNoaWxkKGxpbmtFbGVtKVxyXG4gICAgfVxyXG4gIH0gZWxzZSB7XHJcbiAgICBjb25zb2xlLmVycm9yKGkxOG4oJ3Z4ZS5lcnJvci5ub3RFeHAnKSlcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsOiBzdHJpbmcpIHtcclxuICByZXR1cm4gdmFsLnJlcGxhY2UoL15cIi8sICcnKS5yZXBsYWNlKC9cIiQvLCAnJylcclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VDc3YoY29sdW1uczogYW55W10sIGNvbnRlbnQ6IHN0cmluZykge1xyXG4gIGNvbnN0IGxpc3Q6IHN0cmluZ1tdID0gY29udGVudC5zcGxpdCgnXFxuJylcclxuICBjb25zdCBmaWVsZHM6IGFueVtdID0gW11cclxuICBjb25zdCByb3dzOiBhbnlbXSA9IFtdXHJcbiAgaWYgKGxpc3QubGVuZ3RoKSB7XHJcbiAgICBjb25zdCByTGlzdDogc3RyaW5nW10gPSBsaXN0LnNsaWNlKDEpXHJcbiAgICBsaXN0WzBdLnNwbGl0KCcsJykuZm9yRWFjaCgodmFsOiBzdHJpbmcpID0+IHtcclxuICAgICAgY29uc3QgZmllbGQ6IHN0cmluZyA9IHJlcGxhY2VEb3VibGVRdW90YXRpb24odmFsKVxyXG4gICAgICBpZiAoZmllbGQpIHtcclxuICAgICAgICBmaWVsZHMucHVzaChmaWVsZClcclxuICAgICAgfVxyXG4gICAgfSlcclxuICAgIHJMaXN0LmZvckVhY2goKHI6IHN0cmluZykgPT4ge1xyXG4gICAgICBpZiAocikge1xyXG4gICAgICAgIGNvbnN0IGl0ZW06IGFueSA9IHt9XHJcbiAgICAgICAgci5zcGxpdCgnLCcpLmZvckVhY2goKHZhbDogc3RyaW5nLCBjb2xJbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICBpdGVtW2ZpZWxkc1tjb2xJbmRleF1dID0gcmVwbGFjZURvdWJsZVF1b3RhdGlvbih2YWwpXHJcbiAgICAgICAgfSlcclxuICAgICAgICByb3dzLnB1c2goaXRlbSlcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcbiAgcmV0dXJuIHsgZmllbGRzLCByb3dzIH1cclxufVxyXG5cclxuZnVuY3Rpb24gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnM6IGFueVtdLCBmaWVsZHM6IHN0cmluZ1tdLCByb3dzOiBhbnlbXSkge1xyXG4gIGxldCB0YWJsZUZpZWxkczogc3RyaW5nW10gPSBbXVxyXG4gIGNvbHVtbnMuZm9yRWFjaCgoY29sdW1uOiBhbnkpID0+IHtcclxuICAgIGxldCBmaWVsZDogc3RyaW5nID0gY29sdW1uLnByb3BlcnR5XHJcbiAgICBpZiAoZmllbGQpIHtcclxuICAgICAgdGFibGVGaWVsZHMucHVzaChmaWVsZClcclxuICAgIH1cclxuICB9KVxyXG4gIHJldHVybiB0YWJsZUZpZWxkcy5ldmVyeSgoZmllbGQ6IHN0cmluZykgPT4gZmllbGRzLmluY2x1ZGVzKGZpZWxkKSlcclxufVxyXG5cclxuZnVuY3Rpb24gaW1wb3J0WExTWChwYXJhbXM6IGFueSkge1xyXG4gIGNvbnN0IHsgJHRhYmxlLCBjb2x1bW5zLCBvcHRpb25zLCBmaWxlIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IF9pbXBvcnRDYWxsYmFjayB9ID0gJHRhYmxlXHJcbiAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICBmaWxlUmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkKGUudGFyZ2V0LnJlc3VsdCwgeyB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gICAgY29uc3QgY3N2RGF0YTogc3RyaW5nID0gWExTWC51dGlscy5zaGVldF90b19jc3Yod29ya2Jvb2suU2hlZXRzLlNoZWV0MSlcclxuICAgIGNvbnN0IHJlc3Q6IGFueSA9IHBhcnNlQ3N2KGNvbHVtbnMsIGNzdkRhdGEpXHJcbiAgICBjb25zdCB7IGZpZWxkcywgcm93cyB9ID0gcmVzdFxyXG4gICAgY29uc3Qgc3RhdHVzID0gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnMsIGZpZWxkcywgcm93cylcclxuICAgIGlmIChzdGF0dXMpIHtcclxuICAgICAgJHRhYmxlLmNyZWF0ZURhdGEocm93cylcclxuICAgICAgICAudGhlbigoZGF0YTogYW55W10pID0+IHtcclxuICAgICAgICAgIGlmIChvcHRpb25zLm1vZGUgPT09ICdhcHBlbmQnKSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5pbnNlcnRBdChkYXRhLCAtMSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5yZWxvYWREYXRhKGRhdGEpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSkge1xyXG4gICAgICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUudGFibGUuaW1wU3VjY2VzcycpLCBzdGF0dXM6ICdzdWNjZXNzJyB9KVxyXG4gICAgICB9XHJcbiAgICB9IGVsc2UgaWYgKG9wdGlvbnMubWVzc2FnZSkge1xyXG4gICAgICAkdGFibGUuJFhNb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogaTE4bigndnhlLmVycm9yLmltcEZpZWxkcycpLCBzdGF0dXM6ICdlcnJvcicgfSlcclxuICAgIH1cclxuICAgIGlmIChfaW1wb3J0Q2FsbGJhY2spIHtcclxuICAgICAgX2ltcG9ydENhbGxiYWNrKHN0YXR1cylcclxuICAgIH1cclxuICB9XHJcbiAgZmlsZVJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoZmlsZSlcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlSW1wb3J0RXZlbnQocGFyYW1zOiBhbnkpIHtcclxuICBzd2l0Y2ggKHBhcmFtcy5vcHRpb25zLnR5cGUpIHtcclxuICAgIGNhc2UgJ3hsc3gnOlxyXG4gICAgICBpbXBvcnRYTFNYKHBhcmFtcylcclxuICAgICAgcmV0dXJuIGZhbHNlXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVFeHBvcnRFdmVudChwYXJhbXM6IGFueSkge1xyXG4gIHN3aXRjaCAocGFyYW1zLm9wdGlvbnMudHlwZSkge1xyXG4gICAgY2FzZSAneGxzeCc6XHJcbiAgICAgIGV4cG9ydFhMU1gocGFyYW1zKVxyXG4gICAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOetieagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0OiBhbnkgPSB7XHJcbiAgaW5zdGFsbCh4dGFibGU6IHR5cGVvZiBWWEVUYWJsZSkge1xyXG4gICAgT2JqZWN0LmFzc2lnbih4dGFibGUudHlwZXMsIHsgeGxzeDogMSB9KVxyXG4gICAgeHRhYmxlLmludGVyY2VwdG9yLm1peGluKHtcclxuICAgICAgJ2V2ZW50LmltcG9ydCc6IGhhbmRsZUltcG9ydEV2ZW50LFxyXG4gICAgICAnZXZlbnQuZXhwb3J0JzogaGFuZGxlRXhwb3J0RXZlbnRcclxuICAgIH0pXHJcbiAgICBWWEVUYWJsZVBsdWdpbkV4cG9ydC50ID0geHRhYmxlLnRcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGkxOG4oa2V5OiBzdHJpbmcpIHtcclxuICBpZiAoVlhFVGFibGVQbHVnaW5FeHBvcnQudCkge1xyXG4gICAgcmV0dXJuIFZYRVRhYmxlUGx1Z2luRXhwb3J0LnQoa2V5KVxyXG4gIH1cclxufVxyXG5cclxuaWYgKHR5cGVvZiB3aW5kb3cgIT09ICd1bmRlZmluZWQnICYmIHdpbmRvdy5WWEVUYWJsZSkge1xyXG4gIHdpbmRvdy5WWEVUYWJsZS51c2UoVlhFVGFibGVQbHVnaW5FeHBvcnQpXHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IFZYRVRhYmxlUGx1Z2luRXhwb3J0XHJcbiJdfQ==

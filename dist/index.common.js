"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.VXETablePluginExportXLSX = void 0;

var _xeUtils = _interopRequireDefault(require("xe-utils/methods/xe-utils"));

var _xlsx = _interopRequireDefault(require("xlsx"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { "default": obj }; }

function getSeq($table, row, rowIndex, column, columnIndex) {
  // 在 v3.0 中废弃 startIndex、indexMethod
  var seqOpts = $table.seqOpts;
  var seqMethod = seqOpts.seqMethod || column.indexMethod;
  return seqMethod ? seqMethod({
    row: row,
    rowIndex: rowIndex,
    column: column,
    columnIndex: columnIndex
  }) : (seqOpts.startIndex || $table.startIndex) + rowIndex + 1;
}

function toBuffer(wbout) {
  var buf = new ArrayBuffer(wbout.length);
  var view = new Uint8Array(buf);

  for (var index = 0; index !== wbout.length; ++index) {
    view[index] = wbout.charCodeAt(index) & 0xFF;
  }

  return buf;
}

function exportXLSX(params) {
  var $table = params.$table,
      options = params.options,
      columns = params.columns,
      datas = params.datas;
  var sheetName = options.sheetName,
      type = options.type,
      isHeader = options.isHeader,
      isFooter = options.isFooter,
      original = options.original,
      message = options.message,
      footerFilterMethod = options.footerFilterMethod;
  var colHead = {};
  var footList = [];
  var rowList = datas;

  if (isHeader) {
    columns.forEach(function (column) {
      colHead[column.id] = _xeUtils["default"].toString(original ? column.property : column.getTitle());
    });
  }

  if (isFooter) {
    var footerData = $table.footerData;
    var footers = footerFilterMethod ? footerData.filter(footerFilterMethod) : footerData;
    footers.forEach(function (rows) {
      var item = {};
      columns.forEach(function (column) {
        item[column.id] = rows[$table.$getColumnIndex(column)] || '';
      });
      footList.push(item);
    });
  }

  var book = _xlsx["default"].utils.book_new();

  var sheet = _xlsx["default"].utils.json_to_sheet((isHeader ? [colHead] : []).concat(rowList).concat(footList), {
    skipHeader: true
  }); // 转换数据


  _xlsx["default"].utils.book_append_sheet(book, sheet, sheetName);

  var wbout = _xlsx["default"].write(book, {
    bookType: type,
    bookSST: false,
    type: 'binary'
  });

  var blob = new Blob([toBuffer(wbout)], {
    type: 'application/octet-stream'
  }); // 保存导出

  downloadFile(blob, options);

  if (message !== false) {
    $table.$XModal.message({
      message: i18n('vxe.table.expSuccess'),
      status: 'success'
    });
  }
}

function downloadFile(blob, options) {
  if (window.Blob) {
    var filename = options.filename,
        type = options.type;

    if (navigator.msSaveBlob) {
      navigator.msSaveBlob(blob, "".concat(filename, ".").concat(type));
    } else {
      var linkElem = document.createElement('a');
      linkElem.target = '_blank';
      linkElem.download = "".concat(filename, ".").concat(type);
      linkElem.href = URL.createObjectURL(blob);
      document.body.appendChild(linkElem);
      linkElem.click();
      document.body.removeChild(linkElem);
    }
  } else {
    console.error(i18n('vxe.error.notExp'));
  }
}

function replaceDoubleQuotation(val) {
  return val.replace(/^"/, '').replace(/"$/, '');
}

function parseCsv(columns, content) {
  var list = content.split('\n');
  var fields = [];
  var rows = [];

  if (list.length) {
    var rList = list.slice(1);
    list[0].split(',').map(replaceDoubleQuotation);
    rList.forEach(function (r) {
      if (r) {
        var item = {};
        r.split(',').forEach(function (val, colIndex) {
          if (fields[colIndex]) {
            item[fields[colIndex]] = replaceDoubleQuotation(val);
          }
        });
        rows.push(item);
      }
    });
  }

  return {
    fields: fields,
    rows: rows
  };
}

function checkImportData(columns, fields, rows) {
  var tableFields = [];
  columns.forEach(function (column) {
    var field = column.property;

    if (field) {
      tableFields.push(field);
    }
  });
  return tableFields.every(function (field) {
    return fields.includes(field);
  });
}

function importXLSX(params) {
  var $table = params.$table,
      columns = params.columns,
      options = params.options,
      file = params.file;
  var _importCallback = $table._importCallback,
      _importResolve = $table._importResolve;
  var fileReader = new FileReader();

  fileReader.onload = function (e) {
    var workbook = _xlsx["default"].read(e.target.result, {
      type: 'binary'
    });

    var csvData = _xlsx["default"].utils.sheet_to_csv(workbook.Sheets.Sheet1);

    var rest = parseCsv(columns, csvData);
    var fields = rest.fields,
        rows = rest.rows;
    var status = checkImportData(columns, fields, rows);

    if (status) {
      $table.createData(rows).then(function (data) {
        if (options.mode === 'append') {
          $table.insertAt(data, -1);
        } else {
          $table.reloadData(data);
        }
      });

      if (options.message !== false) {
        $table.$XModal.message({
          message: i18n('vxe.table.impSuccess'),
          status: 'success'
        });
      }
    } else if (options.message !== false) {
      $table.$XModal.message({
        message: i18n('vxe.error.impFields'),
        status: 'error'
      });
    }

    if (_importResolve) {
      _importResolve(status);

      $table._importResolve = null;
    } else if (_importCallback) {
      // 已废弃
      _importCallback(status);

      $table._importCallback = null;
    }
  };

  fileReader.readAsBinaryString(file);
}

function handleImportEvent(params) {
  if (params.options.type === 'xlsx') {
    importXLSX(params);
    return false;
  }
}

function handleExportEvent(params) {
  if (params.options.type === 'xlsx') {
    exportXLSX(params);
    return false;
  }
}
/**
 * 基于 vxe-table 表格的增强插件，支持导出 xlsx 格式
 */


var VXETablePluginExportXLSX = {
  install: function install(xtable) {
    Object.assign(xtable.types, {
      xlsx: 1
    });
    xtable.interceptor.mixin({
      'event.import': handleImportEvent,
      'event.export': handleExportEvent
    });
    VXETablePluginExportXLSX.t = xtable.t;
  }
};
exports.VXETablePluginExportXLSX = VXETablePluginExportXLSX;

function i18n(key) {
  if (VXETablePluginExportXLSX.t) {
    return VXETablePluginExportXLSX.t(key);
  }
}

if (typeof window !== 'undefined' && window.VXETable) {
  window.VXETable.use(VXETablePluginExportXLSX);
}

var _default = VXETablePluginExportXLSX;
exports["default"] = _default;
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LnRzIl0sIm5hbWVzIjpbImdldFNlcSIsIiR0YWJsZSIsInJvdyIsInJvd0luZGV4IiwiY29sdW1uIiwiY29sdW1uSW5kZXgiLCJzZXFPcHRzIiwic2VxTWV0aG9kIiwiaW5kZXhNZXRob2QiLCJzdGFydEluZGV4IiwidG9CdWZmZXIiLCJ3Ym91dCIsImJ1ZiIsIkFycmF5QnVmZmVyIiwibGVuZ3RoIiwidmlldyIsIlVpbnQ4QXJyYXkiLCJpbmRleCIsImNoYXJDb2RlQXQiLCJleHBvcnRYTFNYIiwicGFyYW1zIiwib3B0aW9ucyIsImNvbHVtbnMiLCJkYXRhcyIsInNoZWV0TmFtZSIsInR5cGUiLCJpc0hlYWRlciIsImlzRm9vdGVyIiwib3JpZ2luYWwiLCJtZXNzYWdlIiwiZm9vdGVyRmlsdGVyTWV0aG9kIiwiY29sSGVhZCIsImZvb3RMaXN0Iiwicm93TGlzdCIsImZvckVhY2giLCJpZCIsIlhFVXRpbHMiLCJ0b1N0cmluZyIsInByb3BlcnR5IiwiZ2V0VGl0bGUiLCJmb290ZXJEYXRhIiwiZm9vdGVycyIsImZpbHRlciIsInJvd3MiLCJpdGVtIiwiJGdldENvbHVtbkluZGV4IiwicHVzaCIsImJvb2siLCJYTFNYIiwidXRpbHMiLCJib29rX25ldyIsInNoZWV0IiwianNvbl90b19zaGVldCIsImNvbmNhdCIsInNraXBIZWFkZXIiLCJib29rX2FwcGVuZF9zaGVldCIsIndyaXRlIiwiYm9va1R5cGUiLCJib29rU1NUIiwiYmxvYiIsIkJsb2IiLCJkb3dubG9hZEZpbGUiLCIkWE1vZGFsIiwiaTE4biIsInN0YXR1cyIsIndpbmRvdyIsImZpbGVuYW1lIiwibmF2aWdhdG9yIiwibXNTYXZlQmxvYiIsImxpbmtFbGVtIiwiZG9jdW1lbnQiLCJjcmVhdGVFbGVtZW50IiwidGFyZ2V0IiwiZG93bmxvYWQiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiYm9keSIsImFwcGVuZENoaWxkIiwiY2xpY2siLCJyZW1vdmVDaGlsZCIsImNvbnNvbGUiLCJlcnJvciIsInJlcGxhY2VEb3VibGVRdW90YXRpb24iLCJ2YWwiLCJyZXBsYWNlIiwicGFyc2VDc3YiLCJjb250ZW50IiwibGlzdCIsInNwbGl0IiwiZmllbGRzIiwickxpc3QiLCJzbGljZSIsIm1hcCIsInIiLCJjb2xJbmRleCIsImNoZWNrSW1wb3J0RGF0YSIsInRhYmxlRmllbGRzIiwiZmllbGQiLCJldmVyeSIsImluY2x1ZGVzIiwiaW1wb3J0WExTWCIsImZpbGUiLCJfaW1wb3J0Q2FsbGJhY2siLCJfaW1wb3J0UmVzb2x2ZSIsImZpbGVSZWFkZXIiLCJGaWxlUmVhZGVyIiwib25sb2FkIiwiZSIsIndvcmtib29rIiwicmVhZCIsInJlc3VsdCIsImNzdkRhdGEiLCJzaGVldF90b19jc3YiLCJTaGVldHMiLCJTaGVldDEiLCJyZXN0IiwiY3JlYXRlRGF0YSIsInRoZW4iLCJkYXRhIiwibW9kZSIsImluc2VydEF0IiwicmVsb2FkRGF0YSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImhhbmRsZUltcG9ydEV2ZW50IiwiaGFuZGxlRXhwb3J0RXZlbnQiLCJWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1giLCJpbnN0YWxsIiwieHRhYmxlIiwiT2JqZWN0IiwiYXNzaWduIiwidHlwZXMiLCJ4bHN4IiwiaW50ZXJjZXB0b3IiLCJtaXhpbiIsInQiLCJrZXkiLCJWWEVUYWJsZSIsInVzZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBOzs7O0FBRUEsU0FBU0EsTUFBVCxDQUFnQkMsTUFBaEIsRUFBNkJDLEdBQTdCLEVBQXVDQyxRQUF2QyxFQUF5REMsTUFBekQsRUFBc0VDLFdBQXRFLEVBQXlGO0FBQ3ZGO0FBQ0EsTUFBSUMsT0FBTyxHQUFHTCxNQUFNLENBQUNLLE9BQXJCO0FBQ0EsTUFBSUMsU0FBUyxHQUFHRCxPQUFPLENBQUNDLFNBQVIsSUFBcUJILE1BQU0sQ0FBQ0ksV0FBNUM7QUFDQSxTQUFPRCxTQUFTLEdBQUdBLFNBQVMsQ0FBQztBQUFFTCxJQUFBQSxHQUFHLEVBQUhBLEdBQUY7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dkUsTUFBUCxLQUFrQixXQUFsQixJQUFpQ0EsTUFBTSxDQUFDd0UsUUFBNUMsRUFBc0Q7QUFDcER4RSxFQUFBQSxNQUFNLENBQUN3RSxRQUFQLENBQWdCQyxHQUFoQixDQUFvQlosd0JBQXBCO0FBQ0Q7O2VBRWNBLHdCIiwiZmlsZSI6ImluZGV4LmNvbW1vbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBYRVV0aWxzIGZyb20gJ3hlLXV0aWxzL21ldGhvZHMveGUtdXRpbHMnXHJcbmltcG9ydCBWWEVUYWJsZSBmcm9tICd2eGUtdGFibGUvbGliL3Z4ZS10YWJsZSdcclxuaW1wb3J0IFhMU1ggZnJvbSAneGxzeCdcclxuXHJcbmZ1bmN0aW9uIGdldFNlcSgkdGFibGU6IGFueSwgcm93OiBhbnksIHJvd0luZGV4OiBudW1iZXIsIGNvbHVtbjogYW55LCBjb2x1bW5JbmRleDogbnVtYmVyKSB7XHJcbiAgLy8g5ZyoIHYzLjAg5Lit5bqf5byDIHN0YXJ0SW5kZXjjgIFpbmRleE1ldGhvZFxyXG4gIGxldCBzZXFPcHRzID0gJHRhYmxlLnNlcU9wdHNcclxuICBsZXQgc2VxTWV0aG9kID0gc2VxT3B0cy5zZXFNZXRob2QgfHwgY29sdW1uLmluZGV4TWV0aG9kXHJcbiAgcmV0dXJuIHNlcU1ldGhvZCA/IHNlcU1ldGhvZCh7IHJvdywgcm93SW5kZXgsIGNvbHVtbiwgY29sdW1uSW5kZXggfSkgOiAoKHNlcU9wdHMuc3RhcnRJbmRleCB8fCAkdGFibGUuc3RhcnRJbmRleCkgKyByb3dJbmRleCArIDEpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRvQnVmZmVyKHdib3V0OiBhbnkpIHtcclxuICBsZXQgYnVmID0gbmV3IEFycmF5QnVmZmVyKHdib3V0Lmxlbmd0aClcclxuICBsZXQgdmlldyA9IG5ldyBVaW50OEFycmF5KGJ1ZilcclxuICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4ICE9PSB3Ym91dC5sZW5ndGg7ICsraW5kZXgpIHZpZXdbaW5kZXhdID0gd2JvdXQuY2hhckNvZGVBdChpbmRleCkgJiAweEZGXHJcbiAgcmV0dXJuIGJ1ZlxyXG59XHJcblxyXG5mdW5jdGlvbiBleHBvcnRYTFNYKHBhcmFtczogYW55KSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIG9wdGlvbnMsIGNvbHVtbnMsIGRhdGFzIH0gPSBwYXJhbXNcclxuICBjb25zdCB7IHNoZWV0TmFtZSwgdHlwZSwgaXNIZWFkZXIsIGlzRm9vdGVyLCBvcmlnaW5hbCwgbWVzc2FnZSwgZm9vdGVyRmlsdGVyTWV0aG9kIH0gPSBvcHRpb25zXHJcbiAgY29uc3QgY29sSGVhZDogYW55ID0ge31cclxuICBjb25zdCBmb290TGlzdDogYW55W10gPSBbXVxyXG4gIGNvbnN0IHJvd0xpc3QgPSBkYXRhc1xyXG4gIGlmIChpc0hlYWRlcikge1xyXG4gICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICBjb2xIZWFkW2NvbHVtbi5pZF0gPSBYRVV0aWxzLnRvU3RyaW5nKG9yaWdpbmFsID8gY29sdW1uLnByb3BlcnR5IDogY29sdW1uLmdldFRpdGxlKCkpXHJcbiAgICB9KVxyXG4gIH1cclxuICBpZiAoaXNGb290ZXIpIHtcclxuICAgIGNvbnN0IGZvb3RlckRhdGE6IGFueVtdID0gJHRhYmxlLmZvb3RlckRhdGFcclxuICAgIGNvbnN0IGZvb3RlcnM6IGFueVtdID0gZm9vdGVyRmlsdGVyTWV0aG9kID8gZm9vdGVyRGF0YS5maWx0ZXIoZm9vdGVyRmlsdGVyTWV0aG9kKSA6IGZvb3RlckRhdGFcclxuICAgIGZvb3RlcnMuZm9yRWFjaCgocm93czogYW55W10pID0+IHtcclxuICAgICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgICAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgICAgIGl0ZW1bY29sdW1uLmlkXSA9IHJvd3NbJHRhYmxlLiRnZXRDb2x1bW5JbmRleChjb2x1bW4pXSB8fCAnJ1xyXG4gICAgICB9KVxyXG4gICAgICBmb290TGlzdC5wdXNoKGl0ZW0pXHJcbiAgICB9KVxyXG4gIH1cclxuICBjb25zdCBib29rID0gWExTWC51dGlscy5ib29rX25ldygpXHJcbiAgY29uc3Qgc2hlZXQgPSBYTFNYLnV0aWxzLmpzb25fdG9fc2hlZXQoKGlzSGVhZGVyID8gW2NvbEhlYWRdIDogW10pLmNvbmNhdChyb3dMaXN0KS5jb25jYXQoZm9vdExpc3QpLCB7IHNraXBIZWFkZXI6IHRydWUgfSlcclxuICAvLyDovazmjaLmlbDmja5cclxuICBYTFNYLnV0aWxzLmJvb2tfYXBwZW5kX3NoZWV0KGJvb2ssIHNoZWV0LCBzaGVldE5hbWUpXHJcbiAgY29uc3Qgd2JvdXQgPSBYTFNYLndyaXRlKGJvb2ssIHsgYm9va1R5cGU6IHR5cGUsIGJvb2tTU1Q6IGZhbHNlLCB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gIGNvbnN0IGJsb2IgPSBuZXcgQmxvYihbdG9CdWZmZXIod2JvdXQpXSwgeyB0eXBlOiAnYXBwbGljYXRpb24vb2N0ZXQtc3RyZWFtJyB9KVxyXG4gIC8vIOS/neWtmOWvvOWHulxyXG4gIGRvd25sb2FkRmlsZShibG9iLCBvcHRpb25zKVxyXG4gIGlmIChtZXNzYWdlICE9PSBmYWxzZSkge1xyXG4gICAgJHRhYmxlLiRYTW9kYWwubWVzc2FnZSh7IG1lc3NhZ2U6IGkxOG4oJ3Z4ZS50YWJsZS5leHBTdWNjZXNzJyksIHN0YXR1czogJ3N1Y2Nlc3MnIH0pXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkb3dubG9hZEZpbGUoYmxvYjogQmxvYiwgb3B0aW9uczogYW55KSB7XHJcbiAgaWYgKHdpbmRvdy5CbG9iKSB7XHJcbiAgICBjb25zdCB7IGZpbGVuYW1lLCB0eXBlIH0gPSBvcHRpb25zXHJcbiAgICBpZiAobmF2aWdhdG9yLm1zU2F2ZUJsb2IpIHtcclxuICAgICAgbmF2aWdhdG9yLm1zU2F2ZUJsb2IoYmxvYiwgYCR7ZmlsZW5hbWV9LiR7dHlwZX1gKVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdmFyIGxpbmtFbGVtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpXHJcbiAgICAgIGxpbmtFbGVtLnRhcmdldCA9ICdfYmxhbmsnXHJcbiAgICAgIGxpbmtFbGVtLmRvd25sb2FkID0gYCR7ZmlsZW5hbWV9LiR7dHlwZX1gXHJcbiAgICAgIGxpbmtFbGVtLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpXHJcbiAgICAgIGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQobGlua0VsZW0pXHJcbiAgICAgIGxpbmtFbGVtLmNsaWNrKClcclxuICAgICAgZG9jdW1lbnQuYm9keS5yZW1vdmVDaGlsZChsaW5rRWxlbSlcclxuICAgIH1cclxuICB9IGVsc2Uge1xyXG4gICAgY29uc29sZS5lcnJvcihpMThuKCd2eGUuZXJyb3Iubm90RXhwJykpXHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbDogc3RyaW5nKSB7XHJcbiAgcmV0dXJuIHZhbC5yZXBsYWNlKC9eXCIvLCAnJykucmVwbGFjZSgvXCIkLywgJycpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIHBhcnNlQ3N2KGNvbHVtbnM6IGFueVtdLCBjb250ZW50OiBzdHJpbmcpIHtcclxuICBjb25zdCBsaXN0OiBzdHJpbmdbXSA9IGNvbnRlbnQuc3BsaXQoJ1xcbicpXHJcbiAgY29uc3QgZmllbGRzOiBhbnlbXSA9IFtdXHJcbiAgY29uc3Qgcm93czogYW55W10gPSBbXVxyXG4gIGlmIChsaXN0Lmxlbmd0aCkge1xyXG4gICAgY29uc3Qgckxpc3Q6IHN0cmluZ1tdID0gbGlzdC5zbGljZSgxKVxyXG4gICAgbGlzdFswXS5zcGxpdCgnLCcpLm1hcChyZXBsYWNlRG91YmxlUXVvdGF0aW9uKVxyXG4gICAgckxpc3QuZm9yRWFjaCgocjogc3RyaW5nKSA9PiB7XHJcbiAgICAgIGlmIChyKSB7XHJcbiAgICAgICAgY29uc3QgaXRlbTogYW55ID0ge31cclxuICAgICAgICByLnNwbGl0KCcsJykuZm9yRWFjaCgodmFsOiBzdHJpbmcsIGNvbEluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgIGlmIChmaWVsZHNbY29sSW5kZXhdKSB7XHJcbiAgICAgICAgICAgIGl0ZW1bZmllbGRzW2NvbEluZGV4XV0gPSByZXBsYWNlRG91YmxlUXVvdGF0aW9uKHZhbClcclxuICAgICAgICAgIH1cclxuICAgICAgICB9KVxyXG4gICAgICAgIHJvd3MucHVzaChpdGVtKVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuICByZXR1cm4geyBmaWVsZHMsIHJvd3MgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBjaGVja0ltcG9ydERhdGEoY29sdW1uczogYW55W10sIGZpZWxkczogc3RyaW5nW10sIHJvd3M6IGFueVtdKSB7XHJcbiAgbGV0IHRhYmxlRmllbGRzOiBzdHJpbmdbXSA9IFtdXHJcbiAgY29sdW1ucy5mb3JFYWNoKChjb2x1bW46IGFueSkgPT4ge1xyXG4gICAgbGV0IGZpZWxkOiBzdHJpbmcgPSBjb2x1bW4ucHJvcGVydHlcclxuICAgIGlmIChmaWVsZCkge1xyXG4gICAgICB0YWJsZUZpZWxkcy5wdXNoKGZpZWxkKVxyXG4gICAgfVxyXG4gIH0pXHJcbiAgcmV0dXJuIHRhYmxlRmllbGRzLmV2ZXJ5KChmaWVsZDogc3RyaW5nKSA9PiBmaWVsZHMuaW5jbHVkZXMoZmllbGQpKVxyXG59XHJcblxyXG5mdW5jdGlvbiBpbXBvcnRYTFNYKHBhcmFtczogYW55KSB7XHJcbiAgY29uc3QgeyAkdGFibGUsIGNvbHVtbnMsIG9wdGlvbnMsIGZpbGUgfSA9IHBhcmFtc1xyXG4gIGNvbnN0IHsgX2ltcG9ydENhbGxiYWNrLCBfaW1wb3J0UmVzb2x2ZSB9ID0gJHRhYmxlXHJcbiAgY29uc3QgZmlsZVJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKClcclxuICBmaWxlUmVhZGVyLm9ubG9hZCA9IChlOiBhbnkpID0+IHtcclxuICAgIGNvbnN0IHdvcmtib29rID0gWExTWC5yZWFkKGUudGFyZ2V0LnJlc3VsdCwgeyB0eXBlOiAnYmluYXJ5JyB9KVxyXG4gICAgY29uc3QgY3N2RGF0YTogc3RyaW5nID0gWExTWC51dGlscy5zaGVldF90b19jc3Yod29ya2Jvb2suU2hlZXRzLlNoZWV0MSlcclxuICAgIGNvbnN0IHJlc3Q6IGFueSA9IHBhcnNlQ3N2KGNvbHVtbnMsIGNzdkRhdGEpXHJcbiAgICBjb25zdCB7IGZpZWxkcywgcm93cyB9ID0gcmVzdFxyXG4gICAgY29uc3Qgc3RhdHVzID0gY2hlY2tJbXBvcnREYXRhKGNvbHVtbnMsIGZpZWxkcywgcm93cylcclxuICAgIGlmIChzdGF0dXMpIHtcclxuICAgICAgJHRhYmxlLmNyZWF0ZURhdGEocm93cylcclxuICAgICAgICAudGhlbigoZGF0YTogYW55W10pID0+IHtcclxuICAgICAgICAgIGlmIChvcHRpb25zLm1vZGUgPT09ICdhcHBlbmQnKSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5pbnNlcnRBdChkYXRhLCAtMSlcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICR0YWJsZS5yZWxvYWREYXRhKGRhdGEpXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSlcclxuICAgICAgaWYgKG9wdGlvbnMubWVzc2FnZSAhPT0gZmFsc2UpIHtcclxuICAgICAgICAkdGFibGUuJFhNb2RhbC5tZXNzYWdlKHsgbWVzc2FnZTogaTE4bigndnhlLnRhYmxlLmltcFN1Y2Nlc3MnKSwgc3RhdHVzOiAnc3VjY2VzcycgfSlcclxuICAgICAgfVxyXG4gICAgfSBlbHNlIGlmIChvcHRpb25zLm1lc3NhZ2UgIT09IGZhbHNlKSB7XHJcbiAgICAgICR0YWJsZS4kWE1vZGFsLm1lc3NhZ2UoeyBtZXNzYWdlOiBpMThuKCd2eGUuZXJyb3IuaW1wRmllbGRzJyksIHN0YXR1czogJ2Vycm9yJyB9KVxyXG4gICAgfVxyXG4gICAgaWYgKF9pbXBvcnRSZXNvbHZlKSB7XHJcbiAgICAgIF9pbXBvcnRSZXNvbHZlKHN0YXR1cylcclxuICAgICAgJHRhYmxlLl9pbXBvcnRSZXNvbHZlID0gbnVsbFxyXG4gICAgfSBlbHNlIGlmIChfaW1wb3J0Q2FsbGJhY2spIHtcclxuICAgICAgLy8g5bey5bqf5byDXHJcbiAgICAgIF9pbXBvcnRDYWxsYmFjayhzdGF0dXMpXHJcbiAgICAgICR0YWJsZS5faW1wb3J0Q2FsbGJhY2sgPSBudWxsXHJcbiAgICB9XHJcbiAgfVxyXG4gIGZpbGVSZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGZpbGUpXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUltcG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgaW1wb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhhbmRsZUV4cG9ydEV2ZW50KHBhcmFtczogYW55KSB7XHJcbiAgaWYgKHBhcmFtcy5vcHRpb25zLnR5cGUgPT09ICd4bHN4Jykge1xyXG4gICAgZXhwb3J0WExTWChwYXJhbXMpXHJcbiAgICByZXR1cm4gZmFsc2VcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiDln7rkuo4gdnhlLXRhYmxlIOihqOagvOeahOWinuW8uuaPkuS7tu+8jOaUr+aMgeWvvOWHuiB4bHN4IOagvOW8j1xyXG4gKi9cclxuZXhwb3J0IGNvbnN0IFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWDogYW55ID0ge1xyXG4gIGluc3RhbGwoeHRhYmxlOiB0eXBlb2YgVlhFVGFibGUpIHtcclxuICAgIE9iamVjdC5hc3NpZ24oeHRhYmxlLnR5cGVzLCB7IHhsc3g6IDEgfSlcclxuICAgIHh0YWJsZS5pbnRlcmNlcHRvci5taXhpbih7XHJcbiAgICAgICdldmVudC5pbXBvcnQnOiBoYW5kbGVJbXBvcnRFdmVudCxcclxuICAgICAgJ2V2ZW50LmV4cG9ydCc6IGhhbmRsZUV4cG9ydEV2ZW50XHJcbiAgICB9KVxyXG4gICAgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYLnQgPSB4dGFibGUudFxyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaTE4bihrZXk6IHN0cmluZykge1xyXG4gIGlmIChWWEVUYWJsZVBsdWdpbkV4cG9ydFhMU1gudCkge1xyXG4gICAgcmV0dXJuIFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWC50KGtleSlcclxuICB9XHJcbn1cclxuXHJcbmlmICh0eXBlb2Ygd2luZG93ICE9PSAndW5kZWZpbmVkJyAmJiB3aW5kb3cuVlhFVGFibGUpIHtcclxuICB3aW5kb3cuVlhFVGFibGUudXNlKFZYRVRhYmxlUGx1Z2luRXhwb3J0WExTWClcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgVlhFVGFibGVQbHVnaW5FeHBvcnRYTFNYXHJcbiJdfQ==
